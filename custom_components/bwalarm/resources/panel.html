<!-- Panel for bwalarm integration  -->
<script>
  {
    // show the version of your custom UI in the HA dev info panel (HA 0.66.0+):
    const _NAME = 'Alarm Panel';
    const _URL = 'https://github.com/akasma74/Hass-Custom-Alarm';
    // don't forget to change HaPanelAlarm.version below!
    var _VERSION = 'v1.12.14';

    if (!window.CUSTOM_UI_LIST) window.CUSTOM_UI_LIST = [];
    window.CUSTOM_UI_LIST.push({
      name: _NAME,
      url: _URL,
      version: _VERSION
    });

    if (!customElements.get("ha-switch") && customElements.get("paper-toggle-button")) {
      customElements.define("ha-switch", class extends customElements.get("paper-toggle-button") {})
    }
    if (!customElements.get("ha-icon-button") && customElements.get("paper-icon-button")) {
      customElements.define("ha-icon-button", class extends customElements.get("paper-icon-button") {})
    }
    if (!customElements.get("ha-icon") && customElements.get("iron-icon")) {
      customElements.define("ha-icon", class extends customElements.get("iron-icon") {})
    }
  }
  </script>

  <script src='/bwalarm/lib/jquery-3.2.1.min.js'></script>
  <script src='/bwalarm/lib/sha256.js'></script>
  <script src='/bwalarm/lib/countdown360.js'></script>
  <script src="/bwalarm/lib/jscolor.js"></script>

  <link rel='import' href='/bwalarm/alarm/custom-element.html'>

  <style>
    @font-face {
      font-family: 'Lobster';
      font-style: normal;
      font-weight: 400;
      src: local('Lobster Regular'), local('Lobster-Regular'), url(/bwalarm/alarm/lobster.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2212, U+2215;
    }
    @import url('./bwalarm/alarm/alarm.css');
  </style>

  <dom-module id='ha-panel-alarm'>
    <template>
      <link rel='stylesheet' href='/bwalarm/alarm/alarm.css'>

      <style include='ha-style iron-flex iron-flex-factors'>
      </style>
      <!-- ha-app-layout has-scrolling-region -->
      <div id='layout'>
        <div id='status-bar' class='horizontal layout center-justified'>
          <div id='clock' class='box box-header'>
            <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_clock)]]'>
              <div id='time' class='time hours shadow'>
                <span>[[time]]</span>
              </div>
            </template>
            <div id='countdown' class='countdown-timer'></div>
          </div>

          <div id='alarm-status' class='box box-header'>
            <template is='dom-if' if='[[!alarm.attributes.panel_locked]]'>
              <span class='shadow'>[[_alarmStatus(alarm_state, panel_title)]]</span>
            </template>
            <template is='dom-if' if='[[showCodePanel(alarm)]]'>
              <template is='dom-if' if='[[alarm.attributes.panel_locked]]'>
                <span class='shadow'>PANEL LOCKED OUT</span>
              </template>
            </template>
          </div>

          <div id='weather' class='box box-header weather'>
            <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_weather)]]'>
                <div class='weather-summary shadow'>
                  <template is='dom-if' if='[[!isChecked(alarm.attributes.panel.enable_fahrenheit)]]'>
                    <span>[[temp]] &#176;C</span>
                  </template>
                  <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_fahrenheit)]]'>
                    <span>[[temp]] &#176;F</span>
                  </template>
                </div>
                <div id='weather-icon' class='weather-summary'>
                  <object id='weather_svg' class='weather-summary' type='image/svg+xml' data='[[weather.attributes.entity_picture]]'></object>
                </div>
                <div class='weather-summary shadow'>
                  <span>[[weather.state]]</span>
                </div>
            </template>
          </div>
        </div>

        <div id='content'>
<!--          <div id='alarm-panel' style='display: flex; flex-direction: column; height: 100%;'>-->

            <div id='main-content'>

              <div id='carousel_main' class='content-box'>
                <!-- ###########################################CAROUSEL MAIN############################################### -->
                <div id='carousel_template' class='carousel-cell carousel-slide-in'> <!-- TODO style='height: 50vh' -->

                </div>

                <!-- ###########################################CONTROLS############################################### -->
                <div id='controls' class='carousel-cell remove'>
                  <template is='dom-if' if='[[showCodePanelWhenBothFalse(alarm, attemptedArm, attemptedArmWithoutCode)]]'>
                    <div id='codepanel' class='horizontal layout center-justified'>
                      <div style='width: 100%'>
                        <!-- 1 2 3 {CLEAR if code to arm required or in Landscape orientation} -->
                        <div class='horizontal layout' style='justify-content: space-evenly;'>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=1>1</button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=2>2</button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=3>3</button>
                          </div>
                          <template is='dom-if' if='[[needHorizontalCodepanel(orientationLandscape, alarm.attributes.code_arm_required)]]'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <!-- insert transparent button to make the layout neat -->
                              <button class$="[[mwc_button__outlined()]] clear" on-click='callAlarmService' data-call='clear'>clear</button>
                            </div>
                          </template>
                        </div>
                        <!-- 4 5 6 {0 if code required to arm or in Landscape orientation}-->
                        <div class='horizontal layout' style='justify-content: space-evenly;'>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=4>4</button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=5>5</button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=6>6</button>
                          </div>
                          <template is='dom-if' if='[[needHorizontalCodepanel(orientationLandscape, alarm.attributes.code_arm_required)]]'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=0>0</button>
                            </div>
                          </template>
                        </div>
                        <!-- 7 8 9 {DISARM if code to arm required or in Landscape orientation}-->
                        <div class='horizontal layout' style='justify-content: space-evenly;'>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=7>
                              <span class="mdc-button__label" data-digit=7>7</span>
                            </button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=8>
                              <span class="mdc-button__label" data-digit=8>8</span>
                            </button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=9>
                              <span class="mdc-button__label" data-digit=9>9</span>
                            </button>
                          </div>
                          <template is='dom-if' if='[[needHorizontalCodepanel(orientationLandscape, alarm.attributes.code_arm_required)]]'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <!-- insert transparent button to make the layout neat -->
                              <button class$="[[mwc_button__raised()]] disarm [[invisibleIfDisarmed(alarm)]]" disabled$=[[isDisarmed(alarm)]] on-click='callAlarmService' data-call='disarm'>disarm</button>
                            </div>
                          </template>
                        </div>
                        <!-- only when no code to arm required or in Portrait orientation: CLEAR 0 {DISARM if not disarmed} -->
                        <template is='dom-if' if='[[!needHorizontalCodepanel(orientationLandscape, alarm.attributes.code_arm_required)]]'>
                          <div class='horizontal layout' style='justify-content: space-evenly;'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__outlined()]] clear" on-click='callclearcode'>clear</button>
                            </div>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__outlined()]]" on-click='callcode' data-digit=0>0</button>
                            </div>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <!-- insert transparent button to make the layout neat -->
                              <button class$="[[mwc_button__raised()]] disarm [[invisibleIfDisarmed(alarm)]]" disabled$=[[isDisarmed(alarm)]] on-click='callAlarmService' data-call='disarm'>disarm</button>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>

                  <!-- when alarm disarmed -->
                  <template is='dom-if' if='[[isDisarmed(alarm)]]'>
                      <!-- If arming with open sensors - show the list -->
                      <template is='dom-if' if='[[attemptedArm]]'>
                        <div class='vertical layout warning-message'>
                          <div style='text-align: center;'>
                            <h1>Open Sensors Found</h1>
                          </div>
                          <div class='sensors'>
                            <template is='dom-repeat' items='[[opensensors_for_attempted_arm(alarm)]]' as='entity'>
                              <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                            </template>
                          </div>
                          <div class='layout horizontal'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__outlined()]]" on-click='callAlarmService' data-call='override' data-arm='attemptArmMode'>override</button>
                            </div>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__raised()]]" on-click='callAlarmService' data-call='cancel'>cancel</button>
                            </div>
                          </div>
                        </div>
                      </template>

                      <!-- if arming with no code when code to arm required - show error message -->
                      <template is='dom-if' if='[[attemptedArmWithoutCode]]'>
                        <div class='vertical layout error-message'>
                          <div style='text-align: center;'>
                            <h1>Error</h1>
                            <span>Please enter code to arm.</span>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__raised()]]" on-click='callAlarmService' data-call='cancel'>ok</button>
                          </div>
                        </div>
                      </template>

                      <!-- show Arm buttons if there is no errors/sensors to show -->
                      <template is='dom-if' if='[[bothFalse(attemptedArm, attemptedArmWithoutCode)]]'>
                        <div class='horizontal layout arm' style='justify-content: space-evenly;'>
                          <template is='dom-if' if='[[isChecked(alarm.attributes.enable_night_mode)]]'>
                            <div class$=[[mwc_button_wrapper_class()]]>
                              <button class$="[[mwc_button__raised()]]" on-click='callAlarmService' data-call='arm' data-arm='alarm_arm_night_from_panel'>night</button>
                            </div>
                          </template>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__raised()]]" on-click='callAlarmService' data-call='arm' data-arm='alarm_arm_home_from_panel'>home</button>
                          </div>
                          <div class$=[[mwc_button_wrapper_class()]]>
                            <button class$="[[mwc_button__raised()]]" on-click='callAlarmService' data-call='arm' data-arm='alarm_arm_away_from_panel'>away</button>
                          </div>
                        </div>
                      </template>
                  </template>
                </div>

                <!-- ###########################################FLOOR PLAN############################################### -->

                  <div id='floorplan' class='carousel-cell remove'>
                    <template is='dom-if' if='{{alarm.attributes.panel.enable_floorplan_panel}}' >
                    <div>
                      <div class='title'>Floor Plan</div>
                      <state-card-content state-obj='[[getObject(alarm.attributes.panel.floorplan)]]' hass='[[hass]]'></state-card-content>
                    </div>
                  </template>
                </div>

                <!-- ########################################### SENSORS############################################### -->
                <div id='sensors' class='carousel-cell remove'>
                  <!-- ###########################################OPEN SENSORS############################################### -->
                  <template is='dom-if' if='[[opencount]]'>
                    <div>
                      <div class='openSensors'>Open Sensors</div>
                          <div class='sensors'>
                          <template is='dom-repeat' items='[[opensensors(alarm, allsensors)]]' as='entity'>
                            <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                          </template>
                        </div>
                    </div>
                  </template>

                  <!-- ###########################################ARMED############################################## -->
                  <template is='dom-if' if='[[!isDisarmed(alarm)]]'>

                    <div >
                      <template is='dom-if' if='[[computeArray(delayed)]]'>
                        <div class='box-sensors'>
                          <div class='sensor-title'>Delayed Sensors</div>
                          <div class='sensors'>
                            <template is='dom-repeat' items='[[delayed]]' as='entity'>
                              <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                            </template>
                          </div>
                        </div>
                      </template>

                      <template is='dom-if' if='[[computeArray(immediate)]'>
                        <div class='box-sensors'>
                          <div class='sensor-title'>Immediate Sensors</div>
                          <div class='sensors'>
                            <template is='dom-repeat' items='[[immediate]]' as='entity'>
                              <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>

                     <div class='box-sensors'>
                       <template is='dom-if' if='[[computeArray(ignored)]]'>
                        <div class='sensor-title'>Inactive Sensors</div>
                        <div class='sensors'>
                          <template is='dom-repeat' items='[[ignored]]' as='entity'>
                            <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                          </template>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- ###########################################DISARMED############################################### -->
                  <template is='dom-if' if='[[isDisarmed(alarm)]]'>
                    <div class='box-sensors'>
                      <div class='sensor-title'>All Sensors</div>
                      <div class='sensors'>
                        <template is='dom-repeat' items='[[opensensors(alarm, allsensors)]]' as='entity'>
                          <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                        </template>
                        <template is='dom-repeat' items='[[closedsensors(alarm, allsensors)]]' as='entity'>
                          <state-card-display state-obj='[[entity]]' hass='[[hass]]' class='tappable' on-tap='entityTapped' data-entity='[[entity.entity_id]]'></state-card-display>
                        </template>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- ###########################################CAMERAS############################################### -->
                <div id='cameras' class='carousel-cell remove'>
                  <div class='title' style='padding-bottom: 10px'>Cameras</div>
                  <div class='info-detail' style='text-align: center; padding-bottom: 5px;'>Cameras refreshed every [[alarm.attributes.panel.camera_update_interval]] seconds</div>
                  <div class=' vLayout'>
                    <template is='dom-repeat' items='[[alarm.attributes.panel.cameras]]' as='camera'>
                      <div class='cameras' >
                           <img src='[[updateCameraFeedSrc(camera, camera_time)]]' class='camera camera-feed' alt='[[computeFriendlyName(camera)]]'>
                          <div class='camera-caption'>
                            [[computeFriendlyName(camera)]]
                        </div>
                      </div>
                    </template>
                  </div>
                  </div>

                <!-- ###########################################ACTIVITY LOG############################################### -->
                <div id='log' class='carousel-cell remove'>
                  <template is='dom-if' if='[[isChecked(alarm.attributes.enable_log)]]' >
                      <div class='title'>Activity</div>
                          <div >
                          <template is='dom-repeat' items='[[reverseArray(alarm.attributes.logs, 10)]]' as='entry'>
                            <div style='display:flex; padding: 8px;'>
                              <div>
                                <state-badge id='icon' style$='background-image: url([[computeLog(entry, "image")]]);'></state-badge>
                              </div>
                              <div class='log-item'>
                                <div style='color: var(--info-detail-text-color); margin-right: 5px;'>[[computeLog(entry,'name')]]</div>
                                <div>[[computeLog(entry,'message')]]</div>
                                <span></span>
                                <div class='log-item-date' style='color: var(--info-detail-text-color);'>[[computeLog(entry,'time')]]</div>
                              </div>
                            </div>
                          </template>
                        </div>
                  </template>
                </div>

                  <!-- ###########################################CUSTOM PANEL############################################### -->
                  <div id='custom' class='carousel-cell remove'>
                    <template is='dom-if' if='{{alarm.attributes.panel.enable_custom_panel}}' >
                    <custom-element is-panel></custom-element>
                  </template>
                </div>


                <!-- ########################################################################### SETTINGS ##################################################################################################### -->
                  <div id='settings' class='carousel-cell' style='left: 0 !important;' >
                    <!-- <alarm-settings is-panel></alarm-settings> -->

                  <!-- ###########################################SETTINGS SELECTION BAR############################################### -->

                  <template is='dom-if' if='[[settingsUnlock]]' >
                    <div class='title'>Settings</div>
                    <div id='settings-nav' class='horizontal layout'>
                      <div class='sm horizontal layout'>
                        <div class='settings-nav-inner vertical layout'>
                          <ha-icon-button icon='mdi:information-outline' title='Info' on-click='carouselClick' data-selection='settings-info'></ha-icon-button>
                          <div class='settings-nav-text'>About</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:brush' title='Design' on-click='carouselClick' data-selection='settings-all'></ha-icon-button>
                          <div class='settings-nav-text'>Design</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:dialpad' title='Alarm' on-click='carouselClick' data-selection='settings-alarm'></ha-icon-button>
                          <div class='settings-nav-text'>Alarm</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button id='btn-alarm-sensors' icon='mdi:radio-tower' title='Alarm Sensors' on-click='carouselClick' data-selection='settings-sensors'></ha-icon-button>
                          <div class='settings-nav-text'>Sensors</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:floor-plan' title='Floorplan' on-click='carouselClick' data-selection='settings-floorplan'></ha-icon-button>
                          <div class='settings-nav-text'>Floorplan</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:cctv' title='Camera' on-click='carouselClick' data-selection='settings-cameras'></ha-icon-button>
                          <div class='settings-nav-text'>Cameras</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:access-point' title='MQTT' on-click='carouselClick' data-selection='settings-mqtt'></ha-icon-button>
                          <div class='settings-nav-text'>MQTT</div>
                        </div>
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:atom' title='Custom Panel' on-click='carouselClick' data-selection='settings-custom'></ha-icon-button>
                          <div class='settings-nav-text'>Custom</div>
                        </div>
                        <!-- <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:help' title='Help Guide' on-click='carouselClick' data-selection='settings-help'></ha-icon-button>
                          <div class='settings-nav-text'>Help</div>
                        </div> -->
                        <div class='settings-nav-inner vertical layout' >
                          <ha-icon-button icon='mdi:logout' title='Logout' on-click='carouselClick' data-selection='set-login'></ha-icon-button>
                          <div class='settings-nav-text'>Logout</div>
                        </div>
                      </div>

                      <paper-dropdown-menu class='xs dropdown-content' label="Settings">
                        <paper-listbox slot="dropdown-content" >
                          <paper-item on-click='carouselClick' data-selection='settings-info'><ha-icon icon='mdi:information-outline'></ha-icon>About</paper-item>
                          <paper-item on-click='carouselClick' data-selection='settings-all'><ha-icon icon='mdi:brush'></ha-icon>Design</paper-item>
                            <paper-item on-click='carouselClick' data-selection='settings-alarm'><ha-icon icon='mdi:dialpad'></ha-icon>Alarm</paper-item>
                            <paper-item on-click='carouselClick' data-selection='settings-sensors'><ha-icon icon='mdi:radio-tower'></ha-icon>Sensors</paper-item>
                          <paper-item on-click='carouselClick' data-selection='settings-floorplan'><ha-icon icon='mdi:floor-plan'></ha-icon>Floorplan</paper-item>
                          <paper-item on-click='carouselClick' data-selection='settings-cameras'><ha-icon icon='mdi:cctv'></ha-icon>Cameras</paper-item>
                            <paper-item on-click='carouselClick' data-selection='settings-mqtt'><ha-icon icon='mdi:access-point'></ha-icon>MQTT</paper-item>
                            <paper-item on-click='carouselClick' data-selection='settings-custom'><ha-icon icon='mdi:atom'></ha-icon>Custom</paper-item>
                            <!-- <paper-item on-click='carouselClick' data-selection='settings-help'><ha-icon icon='mdi:help'></ha-icon>Help</paper-item> -->
                          </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                  </template>

                  <div id='carousel_settings'>

                    <!-- ########################################################################### LOGIN ##################################################################################################### -->
                    <div id='set-login' class='carousel-cell remove'>
                      <div class='title'>Settings</div>
                      <!--<div class='info-detail'>Enter the admin password defined in your bwalarm.yaml to access this panel</div>-->
                      <paper-input class="span11" id="passwordInput" type="password" placeholder="Enter admin password..." on-keyup='checkSettingsPassword'></paper-input>
                    </div>

                    <!-- ########################################################################### INFO ##################################################################################################### -->
                    <div id='settings-info' class='carousel-cell remove'>

                      <div class='setting-outer vertical layout'>

                        <h1><ha-icon icon='mdi:heart-pulse' style='padding-right: 8px'></ha-icon>Help Support This Work</h1>

                        <span class='info-detail'>Thanks to the community for all the input into this. Consider supporting this project and donate! All funds will go towards bug squashing! It is a community effort to make both the alarm and this smart panel feature-rich as well as simple to deploy and use. We need all the help we can get!</span>
                        <div class='setting-inner horizontal layout flexwrap' style='padding-top: 10px;'>

                          <div class='vertical layout donate-box'>
                            <div id='paypal' class='donate-paypal'>
                              <a href='https://paypal.me/haCustomAlarmak74' class='info-detail'>
                                <span class='info-header'>Paypal:</span>
                                <div class='logo'></div>
                                <span class='info-detail'>Donate</span>
                              </a>
                            </div>
                          </div>

                          <div class='vertical layout donate-box'>
                            <div id='btc' class='donate' data-address='1MkVDAknwXcV3FeoQpDCCPSSzmpAxpgQ6g'>
                              <span class='info-header'>Bitcoin (BTC):</span>
                              <div class='logo'></div>
                            </div>
                            <span class='info-detail'>1MkVDAknwXcV3FeoQpDCCPSSzmpAxpgQ6g</span>
                          </div>

                          <div class='vertical layout donate-box'>
                            <div id='bch' class='donate' data-address='qr3ehu6vdqje76m6w4ppn6sh0j9gwnfxfqymzalkrc'>
                              <span class='info-header'>Bitcoin Cash (BCH):</span>
                              <div class='logo'></div>
                            </div>
                            <span class='info-detail'>qr3ehu6vdqje76m6w4ppn6sh0j9gwnfxfqymzalkrc</span>
                          </div>

                          <div class='vertical layout donate-box'>
                            <div id='ltc' class='donate' data-address='ltc1qvdd488jpus0gkncm8qemhjlettz6ye9253aex0'>
                              <span class='info-header'>Litecoin (LTC):</span>
                              <div class='logo'></div>
                              </div>
                              <span class='info-detail'>ltc1qvdd488jpus0gkncm8qemhjlettz6ye9253aex0</span>
                          </div>

                        </div>
                      </div>

                      <div>
                        <h1>Contribute</h1>
                        <a href='https://github.com/akasma74/Hass-Custom-Alarm/issues'><ha-icon icon='mdi:bug' style='padding-right: 8px'></ha-icon><span>Found a bug or got a feature idea? Let's talk about it on Github</span></a><br>
                        <ha-icon icon='mdi:earth' style='padding-right: 8px'></ha-icon><span><a href='https://community.home-assistant.io/t/bwalarm-akasma74-edition/113666'>Talk to your friends and colleagues about how awesome this alarm and smart panel is</a></span><br>

                      </div>

                      <div>
                        <h1>Your Versions:</h1>
                        <div>
                          <p><span class='info-header'>This integration: </span><span class='info-detail'>[[version]]</span></p>
                          <p><span class='info-header'>Home Assistant: </span><span class='info-detail'>v[[hass.config.version]]</span></p>
                          <p><span class='info-header'>Python: </span><span class='info-detail'>v([[alarm.attributes.py_version]])</span></p>
                        </div>
                      </div>

                      <div>
                        <template is='dom-if' if='[[errors]]' >
                          <h1>Issues:</h1>
                          <div>
                            <template is='dom-repeat' items='[[errors]]' as='entity'>
                              <p class='info-detail'>&#8226;  [[entity]]</p>
                            </template>
                          </div>
                        </template>
                      </div>

                      <button id='restart' data-type='button' on-click='restartHA'><ha-icon icon='mdi:restart' style='padding-right: 8px'></ha-icon><span>Restart Home Assistant</span></button>

                    </div>

                    <!-- ########################################################################### @PANEL ##################################################################################################### -->
                    <div id='settings-all' class='carousel-cell remove'>
                      <h1>Panel Interface Related:</h1>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Admin Password: </span>
                          <span class='info-detail'>Reset the password used to access this settings panel.</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='admin_password' type="password" placeholder='Admin Password'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='admin_password' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <!-- <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Disable Animations: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.disable_animations)}}' on-change='settingsSave' data-setting='panel' data-attribute='disable_animations'></ha-switch>
                        </div>
                        <span class='info-detail'>If enabled, this will disable all animations. This is designed to improve performance on older devices. NOTE you can also disable animations per user within the user section. This is handy to set animations per device.</span>
                      </div> -->

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Alarm Panel Title: </span>
                          <span class='info-detail'>The text that shows on the header bar.<br>Default: Home Alarm</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='panel_title' value='{{alarm.attributes.panel.panel_title}}' placeholder='Panel Title'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='panel' data-attribute='panel_title' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Clock: </span>
                          <ha-switch class='setting-toggle' checked$='{{isChecked(alarm.attributes.panel.enable_clock)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_clock'></ha-switch>
                        </div>
                        <span class='info-detail'>Enables the clock widget in this panel. A Time Sensor named: 'sensor.time' must exist within your Home Assistant setup</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Clock 12 Hour Mode?: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_clock_12hr)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_clock_12hr'></ha-switch>
                        </div>
                        <span class='info-detail'>Changes the clock to 12hour mode when enabled.<br>Default: Disabled (i.e 24hr mode)</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Weather: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_weather)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_weather'></ha-switch>
                        </div>
                        <span class='info-detail'>Enables the weather widget in this panel. A Weather Sensor named: 'sensor.weather_summary' or 'sensor.dark_sky_summary' must exist within your Home Assistant setup</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Display Fahrenheit: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_fahrenheit)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_fahrenheit'></ha-switch>
                        </div>
                        <span class='info-detail'>Enable this to display the temperaturein Fahrenheit</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Passcode Hidden: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.hide_passcode)}}' on-change='settingsSave' data-setting='panel' data-attribute='hide_passcode'></ha-switch>
                        </div>
                        <span class='info-detail'>Masks the passcode within the panel input box when typing</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Hide HA Sidebar When Armed: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.hide_sidebar)}}' on-change='settingsSave' data-setting='panel' data-attribute='hide_sidebar'></ha-switch>
                        </div>
                        <span class='info-detail'>When the alarm is armed the Home Assistant sidebar will be hidden if enabled. This prevents an intruder simply stopping Home Assistant from the configuration menu. For this to be truly effective use a browser which locks access to the URL function. Note: if your HA is v96.3 or newer, go to your Profile settings in HA and select “Always hide the sidebar” for this option to work correctly.</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Hide Sensors When Armed: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.hide_sensors)}}' on-change='settingsSave' data-setting='panel' data-attribute='hide_sensors'></ha-switch>
                        </div>
                        <span class='info-detail'>When the alarm is armed the sensors panel will be hidden.</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Round Buttons: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.round_buttons)}}' on-change='settingsSave' data-setting='panel' data-attribute='round_buttons'></ha-switch>
                        </div>
                        <span class='info-detail'>Choose whether the alarm buttons should be round or not.</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Shadow Text Effect: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.shadow_effect)}}' on-change='settingsSave' data-setting='panel' data-attribute='shadow_effect'></ha-switch>
                        </div>
                        <span class='info-detail'>Enables the shadow text effect in this panel.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Serif Font: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_serif_font)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_serif_font'></ha-switch>
                        </div>
                        <span class='info-detail'>Enables the 'Lobster' serif font on the title, time and weather within this panel.<br>Default: Disabled</span>
                      </div>

                      <div>
                        <h1>Themes</h1>
                        <div class='info-detail'>Themes allow you to override the default Home Assistant colors.</div>

                        <!-- Themes List [Buttons] {defineColors(themeName), unhide div}  -->
                          <template is='dom-if' if='[[alarm.attributes.themes]]'>
                            <!-- <span class='info-header' style='padding-top: 10px;'>Defined:</span> -->
                            <paper-listbox id='themes-listbox' class='vertical layout'>
                            <template is='dom-repeat' items='[[alarm.attributes.themes]]'>
                              <div class='horizontal layout'>
                                <paper-item on-click='defineColors' data-theme$='[[item.name]]' style='width: 75%;  text-transform: uppercase; text-transform: uppercase;'><ha-icon on-click='defineColors' data-theme$='[[item.name]]' icon='mdi:format-paint' style=' padding-right: 7px;'></ha-icon>[[item.name]]</paper-item>
                                <ha-switch class='setting-toggle' checked$='[[isChecked(item.active)]]' on-change='settingsSave' data-type='boolean' name$='[[item.name]]' data-attribute='activated' data-setting='themes'>Activated?</ha-switch>
                                <ha-icon-button on-click='settingsSave' data-setting='themes' name$='[[item.name]]' data-type='delete' icon='mdi:delete' style='margin-left: 20px; color: white;'></ha-icon-button>
                              </div>
                            </template>
                          </paper-listbox>
                        </template>
                        <button on-click='unhideDiv' data-div='#themeDetail' style='background: unset; text-transform: capitalize;'><ha-icon  on-click='unhideDiv' data-div='#themeDetail' icon='mdi:plus-circle-outline' style='padding-right: 7px;'></ha-icon>New</button>
                      </div>

                      <!-- /* Theme Name [Input] | Update [Button] | Delete [Button] */ -->
                      <div id='themeDetail' class='remove'>

                        <h1>Update Theme</h1>

                        <div class='setting-outer horizontal layout'>
                          <div class='setting-inner vertical layout'>
                            <span class='info-header'>Theme Name: </span>
                            <span class='info-detail'>Name of the theme.</span>
                            <div class='setting-input horizontal layout'>
                              <paper-input id='theme-name' type="text" placeholder='Theme Name'></paper-input>
                              <ha-icon-button id='theme-name-button' data-type='input_text' data-attribute='theme-name' data-setting='themes' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                            </div>
                          </div>
                        </div>

                        <!-- Time Based Settings [TODO] -->

                        <template is='dom-repeat' items='{{settingColors}}' as='color'>
                          <div class='setting-outer vertical layout'>
                            <div class='setting-inner horizontal layout' style='display: block;'>
                              <div style='float: left'>
                                <span class='info-header'>[[color.header]]: </span>
                              </div>
                              <div class='horizontal layout' style='float: right'>
                                <button class='deleteThemeColor' on-click='settingsSave' name$='[[color.theme]]' data-attribute$='[[color.name]]' data-type='clear' data-setting='themes' style='background: unset;'><ha-icon icon='mdi:delete'></ha-icon>Clear?</button>
                                <span class='colPicker' id$='[[color.name]]_span' value='[[color.color]]' style='margin: auto;'></span>
                                <ha-icon-button data-type='color' data-setting='themes' name$='[[color.theme]]' data-attribute$='[[color.name]]' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                              </div>
                            </div>
                            <span class='info-detail'>[[color.description]]</span>
                          </div>
                        </template>
                      </div>
                    </div>

                    <!-- ########################################################################### @ALARM ##################################################################################################### -->
                    <div id='settings-alarm' class='carousel-cell remove'>
                      <h1>Alarm</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Alarm Persistence: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.enable_persistence)}}' on-change='settingsSave' data-setting='root' data-attribute='enable_persistence'></ha-switch>
                        </div>
                        <span class='info-detail'>When enabled, the alarm state is persistently saved when either Home Assistant or the underlying host is restarted. This is useful in the event of power loss.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Master Passcode: </span>
                          <span class='info-detail'>Set the master passcode to arm/disarm your alarm</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='code' type="password" placeholder='Master Passcode'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='code' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Panic Code: </span>
                          <span class='info-detail'>Set the panic code to arm/disarm your alarm. This is a special code which disarms the alarm when used yet sets a panic state within HA. It can therefore be used in conjunction with automations for example notifiying the authorities or someone who is able to help. To the intruder the alarm appears to have disarmed as normal.</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='panic_code' type="password" placeholder='Panic Code'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='panic_code' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Require a passcode to set the alarm: </span>
                          <ha-switch class='setting-toggle' checked='{{alarm.attributes.code_arm_required}}' on-change='settingsSave' data-setting='root' data-attribute='code_to_arm'></ha-switch>
                        </div>
                        <span class='info-detail'>When enabled, a valid master/user passcode is required to arm the alarm. If 'override' is used as a passcode, set the alarm immediately (ignores appropriate Pending Time) regardless of this setting</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Ignore Open Sensors on Arm: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.ignore_open_sensors)}}' on-change='settingsSave' data-setting='root' data-attribute='ignore_open_sensors'></ha-switch>
                        </div>
                        <span class='info-detail'>When Disabled, set alarm only if there is no active sensors detected (safe), otherwise always set. <br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Disarm Attempts: </span>
                          <span class='info-detail'>Amount of allowed disarm attempts before the panel locks out.<br>Default: -1 (no limit)</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='passcode_attempts' value='{{alarm.attributes.passcode_attempts}}' placeholder='Passcode Attempts'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='passcode_attempts' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Disarm Attempts Timeout: </span>
                          <span class='info-detail'>Amount of time in seconds after the panel is locked before a user is allowed to try again.<br>Default: 15 minutes</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='passcode_attempts_timeout' value='{{alarm.attributes.passcode_attempts_timeout}}' placeholder='Passcode Attempts Timeout'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='passcode_attempts_timeout' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Log: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.enable_log)}}' on-change='settingsSave' data-setting='root' data-attribute='enable_log'></ha-switch>
                        </div>
                        <span class='info-detail'>When enabled the alarm records a log, permissions must be granted to HA to allow the log file to be saved in the configuration directory as alarm_log.json.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>log Size: </span>
                          <span class='info-detail'>Amount of records which can be saved and displayed.<br>Default: 10 records</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='log_size' value='{{alarm.attributes.log_size}}' placeholder='Log Size'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='root' data-attribute='log_size' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <!-- ########################################################################### @USERS ##################################################################################################### -->
                      <h1>User Specific Codes</h1>

                      <div class='setting-outer vertical layout'>
                        <span class='info-detail'>This setting provides the ability to configure user specific accounts that are able to control your alarm. If logging is enabled then these users will be captured as part of the log. Home Assistant users using the new authentication system introduced in v0.70 will be automatically imported.</span>
                      </div>

                      <template is='dom-repeat' items='[[alarm.attributes.users]]' as='user'>

                        <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>

                            <div style='margin-top: auto; margin-bottom: auto; margin-left: 15px;'>
                              <ha-switch class='setting-toggle' checked='{{isChecked(user.enabled)}}' data-userid$='[[user.id]]' on-change='toggleUser'>Enable</ha-switch>
                            </div>
                            <button data-type='button' style='background-color: unset; width: 40%;' data-userid$='{{user.id}}' on-click='editUser'>
                              <div style='margin-left: 5px; margin-right: 10px; padding-left: 15px;' data-userid$='[[user.id]]' on-click='editUser'>
                                <state-badge style$='background-image: url({{computeImage(user.picture)}});' data-userid$='[[user.id]]' on-click='editUser'></state-badge>
                              </div>
                              <div style='margin-top: auto; margin-bottom: auto; font-size: large;' data-userid$='[[user.id]]' on-click='editUser'>
                                [[user.name]]
                              </div>
                            </button>

                            <div style='margin-top: auto; margin-bottom: auto;'>
                              <button  data-userid$='[[user.id]]' on-click='deleteUser' style='color: white;background-color: unset;'><ha-icon icon='mdi:delete'></ha-icon>&nbsp;&nbsp;Delete</button>
                            </div>
                          </div>
                        </div>
                      </template>

                      <button id='user-add' data-type='button' on-click='unhideDiv' data-div='#userDetail' style='background-color: unset; margin-bottom: 15px;'><ha-icon icon='mdi:account-plus'></ha-icon>&nbsp;&nbsp;Add A New User</button>

                      <div id='userDetail' class='remove'>

                        <h1>Update User</h1>

                        <div class='setting-outer horizontal layout'>
                          <div class='setting-inner vertical layout'>
                            <span class='info-header'>Name: </span>
                            <span class='info-detail'>Set a name for your user.</span>
                            <div class='setting-input horizontal layout'>
                              <paper-input id='user-name' placeholder='Name of user' required auto-validate error-message="Required." ></paper-input>
                            </div>
                          </div>
                        </div>

                        <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>
                            <span class='info-header'>Enable User: </span>
                            <ha-switch id='user-enabled' checked='true'></ha-switch>
                          </div>
                          <span class='info-detail'>Enable this user to control the alarm?</span>
                        </div>

                        <div class='setting-outer horizontal layout'>
                          <div class='setting-inner vertical layout'>
                            <span class='info-header'>Passcode: </span>
                            <span class='info-detail'>Set a new passcode for your user.</span>
                            <div class='setting-input horizontal layout'>
                              <paper-input id='user-passcode' placeholder='User passcode' type="password" required auto-validate error-message="Required - Minimum of 4 digits/characters" char-counter minlength='4'></paper-input>
                            </div>
                          </div>
                        </div>

                        <div class='setting-outer horizontal layout'>
                          <div class='setting-inner vertical layout'>

                            <span class='info-header'>Badge: </span>
                            <span class='info-detail'>Filename of your picture. You can use standard pictures from [[alarm.attributes.default_images_path]] or your own ones from [[alarm.attributes.override_images_path]]</span>
                            <div class='setting-input horizontal layout'>
                              <state-badge id='user-badge' style='background-image: url("[[default_icon_path]]"); margin-top: auto; margin-bottom: auto; margin-right: 15px;'></state-badge>
                              <paper-input id='user-picture' placeholder='Icon name i.e. myimage.jpg' on-input="loadPreviewImage" ></paper-input>
                            </div>
                          </div>
                        </div>

                        <!-- <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>
                            <span class='info-header'>Disable Animations: </span>
                            <ha-switch id='user-disable_animations' checked='false'></ha-switch>
                          </div>
                          <span class='info-detail'>If enabled, the animations in the panel will be disabled for this user to help with performance on older devices.</span>
                        </div> -->

                        <!-- <h1>Permissions Based Settings</h1>
                        <span class='info-detail'>Customise which areas of the alarm you want to allow your user to control. By default the user can control all areas.</span>

                        <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>
                            <span class='info-header'>Home: </span>
                            <ha-switch id='user-home-permission' checked='true' class='setting-toggle'></ha-switch>
                          </div>
                        </div>

                        <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>
                            <span class='info-header'>Away: </span>
                            <ha-switch id='user-away-permission' checked='true' class='setting-toggle'></ha-switch>
                          </div>
                        </div>

                        <div class='setting-outer vertical layout'>
                          <div class='setting-inner horizontal layout'>
                            <span class='info-header'>Perimeter: </span>
                            <ha-switch id='user-perimeter-permission' checked='true' class='setting-toggle'></ha-switch>
                          </div>
                        </div> -->

                        <button id='user-save' data-type='button' on-click='saveUser' style='background-color: unset; margin-bottom: 15px;'><ha-icon icon='mdi:content-save'></ha-icon>&nbsp;&nbsp;Save User</button>
                        <button on-click='resetUserDetail' style='background-color: unset; margin-bottom: 15px;'><ha-icon icon='mdi:cancel'></ha-icon>&nbsp;&nbsp;Cancel</button>
                      </div>

                    </div>

                    <!-- ########################################################################### @SENSORS ##################################################################################################### -->
                    <div id='settings-sensors' class='carousel-cell remove'>
                      <h1>Sensors</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Sensors Panel: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_sensors_panel)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_sensors_panel'></ha-switch>
                        </div>
                        <span class='info-detail'>Enabling this allows you to view your sensors groups in a panel</span>
                      </div>

                      <h1>Away Mode</h1>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Pending (Exit) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is armed. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Exit Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_away-pending_time' value='[[alarm.attributes.states.armed_away.pending_time]]' placeholder='Pending Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_away' data-attribute='pending_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Warning (Entry) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is triggered. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Entry Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_away-warning_time' value='[[alarm.attributes.states.armed_away.warning_time]]' placeholder='Warning Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_away' data-attribute='warning_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Trigger Time: </span>
                          <span class='info-detail'>The amount of time in seconds the alarm stays triggered before returning to its previous state.<br>Default: 300 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_away-trigger_time' value='[[alarm.attributes.states.armed_away.trigger_time]]' placeholder='Trigger Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_away' data-attribute='trigger_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>

                      </div>

                      <div class='horizontal layout' id='sensors-away-immediate'>

                        <div class='vertical layout'>
                          <h2>Immediate</h2>
                          <paper-listbox id='sensors-checkboxs' class='vertical layout' attr-for-selected='title' multi selected-values='{{alarm.attributes.states.armed_away.immediate}}' selected-attribute='checked' >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="[[sensor]]" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_away' data-group='immediate' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='sensor vertical layout'>
                          <h2>Delayed</h2>
                          <paper-listbox id='sensors-checkboxs1' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_away.delayed}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_away' data-group='delayed' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='vertical layout'>
                          <h2>Override</h2>
                          <paper-listbox id='sensors-checkboxs2' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_away.override}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_away' data-group='override' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>
                      </div>

                      <h1>Home Mode</h1>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Pending (Exit) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is armed. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Exit Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_home-pending_time' value='[[alarm.attributes.states.armed_home.pending_time]]' placeholder='Pending Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_home' data-attribute='pending_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>

                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Warning (Entry) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is triggered. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Entry Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_home-warning_time' value='[[alarm.attributes.states.armed_home.warning_time]]' placeholder='Warning Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_home' data-attribute='warning_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Trigger Time: </span>
                          <span class='info-detail'>The amount of time in seconds the alarm stays triggered before returning to its previous state.<br>Default: 300 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_home-trigger_time' value='[[alarm.attributes.states.armed_home.trigger_time]]' placeholder='Trigger Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_home' data-attribute='trigger_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='horizontal layout'>
                        <div class='vertical layout'>
                          <h2>Immediate</h2>
                          <paper-listbox id='sensors-checkboxs3' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_home.immediate}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_home' data-group='immediate' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='vertical layout'>
                          <h2>Delayed</h2>
                          <paper-listbox id='sensors-checkboxs4' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_home.delayed}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_home' data-group='delayed' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='vertical layout'>
                          <h2>Override</h2>
                          <paper-listbox id='sensors-checkboxs5' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_home.override}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_home' data-group='override' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>
                      </div>

                      <h1>Night (perimeter) Mode</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Night Mode: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.enable_night_mode)}}' on-change='settingsSave' data-setting='root' data-attribute='enable_night_mode'></ha-switch>
                        </div>
                        <span class='info-detail'>Enable night mode.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Pending (Exit) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is armed. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Exit Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_night-pending_time' value='[[alarm.attributes.states.armed_night.pending_time]]' placeholder='Pending Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_night' data-attribute='pending_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Warning (Entry) Time: </span>
                          <span class='info-detail'>Grace time in seconds before the alarm is triggered. Any sensor tripped within this time period will not trigger the alarm. Also known as 'Entry Time'.<br>Default: 25 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_night-warning_time' value='[[alarm.attributes.states.armed_night.warning_time]]' placeholder='Warning Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_night' data-attribute='warning_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Trigger Time: </span>
                          <span class='info-detail'>The amount of time in seconds the alarm stays triggered before returning to its previous state.<br>Default: 300 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='armed_night-trigger_time' value='[[alarm.attributes.states.armed_night.trigger_time]]' placeholder='Trigger Time'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='states' data-mode='armed_night' data-attribute='trigger_time' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='horizontal layout'>
                        <div class='vertical layout'>
                          <h2>Immediate</h2>
                          <paper-listbox id='sensors-checkboxs6' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_night.immediate}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_night' data-group='immediate' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='vertical layout'>
                          <h2>Delayed</h2>
                          <paper-listbox id='sensors-checkboxs7' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_night.delayed}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_night' data-group='delayed' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class='vertical layout'>
                          <h2>Override</h2>
                          <paper-listbox id='sensors-checkboxs8' class='vertical layout' attr-for-selected="title" multi selected-values={{alarm.attributes.states.armed_night.override}} selected-attribute="checked" >
                            <template is='dom-repeat' items='{{sensors}}' as='sensor'>
                              <checkbox type='checkbox' class='checkbox' title="{{sensor}}" on-click='settingsSave' data-setting='sensor_select' data-mode='armed_night' data-group='override' >[[computeFriendlyName(sensor)]]</checkbox>
                            </template>
                          </paper-listbox>
                        </div>
                      </div>

                    </div>

                    <!-- ########################################################################### @FLOORPLAN ##################################################################################################### -->
                    <div id='settings-floorplan' class='carousel-cell remove'>
                      <h1>Floorplan</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Floorplan Panel: </span>
                          <ha-switch class='setting-toggle' checked='{{alarm.attributes.panel.enable_floorplan_panel}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_floorplan_panel'></ha-switch>
                        </div>
                        <span class='info-detail'>Enabling this allows you to setup your custom floorplan to be displayed as a panel</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='horizontal layout'>
                          <div class='setting-inner vertical layout'>
                            <span class='info-header'>Floorplan Entity: </span>
                            <span class='info-detail'>Choose the binary_sensor which relates to your floorplan setup</span>
                          </div>
                        </div>
                        <div class='setting-inner vertical layout'>
                          <paper-listbox id='floorplan-listbox' class='vertical layout' selected='{{alarm.attributes.panel.floorplan}}' attr-for-selected="name" on-selected-item-changed='settingsSave' data-type='listbox' data-setting='panel' data-attribute='floorplan'>
                            <template is='dom-repeat' items='{{sensors}}' as='bs'>
                              <paper-item name="[[bs]]" class='list-item' title="{{bs}}">[[computeFriendlyName(bs)]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>
                      </div>
                    </div>
                    <!-- ########################################################################### CAMERAS ##################################################################################################### -->
                    <div id='settings-cameras' class='carousel-cell remove'>
                      <h1>Cameras</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Camera Panel: </span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.panel.enable_camera_panel)}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_camera_panel'></ha-switch>
                        </div>
                        <span class='info-detail'>Enabling this allows you to add your cameras listed below to be displayed as a panel</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Update Interval: </span>
                          <span class='info-detail'>The time in seconds the camera image updates.<br>Default: 5 seconds</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='camera_update_interval' value='{{alarm.attributes.panel.camera_update_interval}}' placeholder='Update Interval'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='panel' data-attribute='camera_update_interval' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <paper-listbox id='cameras-checkboxs' class='vertical layout' attr-for-selected="name" multi selected-values={{alarm.attributes.panel.cameras}} selected-attribute="checked" on-selected-items-changed='settingsSave' data-type='checkbox' data-setting='panel-cameras'>
                        <template is='dom-repeat' items='{{cameras}}' as='camera'>
                          <checkbox name="{{camera}}" class='checkbox' title$="{{camera}}">[[computeFriendlyName(camera)]]</checkbox>
                        </template>
                      </paper-listbox>
                    </div>

                    <!-- ########################################################################### MQTT ##################################################################################################### -->
                    <div id='settings-mqtt' class='carousel-cell remove'>
                      <h1>MQTT</h1>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable MQTT:</span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.mqtt.enable_mqtt)}}' on-change='settingsSave' data-setting='mqtt' data-attribute='enable_mqtt'></ha-switch>
                        </div>
                        <span class='info-detail'>Enabling this allows you to send and receive MQTT messages to interact with your alarm. Restart Home Assistant for the changes to take effect.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>QOS: </span>
                          <span class='info-detail'>Quality of Service. The maximum QoS level for subscribing and publishing to MQTT messages.<br>Default: 0</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='qos' value='{{alarm.attributes.mqtt.qos}}' placeholder='QOS'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='qos' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>State Topic: </span>
                          <span class='info-detail'>The MQTT topic HA will publish state updates to.<br>Default: home/alarm</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='state_topic' value='{{alarm.attributes.mqtt.state_topic}}' placeholder='State Topic'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='state_topic' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Command Topic: </span>
                          <span class='info-detail'>The MQTT topic HA will subscribe to, to receive commands from a remote device to change the alarm state.<br>Default: home/alarm/set</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='command_topic' value='{{alarm.attributes.mqtt.command_topic}}' placeholder='Command Topic'></paper-input>
                            <ha-icon-button data-type='imput_text' data-setting='mqtt' data-attribute='command_topic' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Arm Night command: </span>
                          <span class='info-detail'>Command to set armed-night mode on this Alarm Panel.<br>Default: ARM_NIGHT</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='payload_arm_night' value='{{alarm.attributes.mqtt.payload_arm_night}}' placeholder='Payload Night'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='payload_arm_night' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Arm Home command: </span>
                          <span class='info-detail'>Command to set armed-home mode.<br>Default: ARM_HOME</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='payload_arm_home' value='{{alarm.attributes.mqtt.payload_arm_home}}' placeholder='Payload Home'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='payload_arm_home' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Arm Away command: </span>
                          <span class='info-detail'>Command to set armed-away mode.<br>Default: ARM_AWAY</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='payload_arm_away' value='{{alarm.attributes.mqtt.payload_arm_away}}' placeholder='Payload Away'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='payload_arm_away' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer horizontal layout'>
                        <div class='setting-inner vertical layout'>
                          <span class='info-header'>Disarm command: </span>
                          <span class='info-detail'>Command to disarm this Alarm Panel.<br>Default: DISARM</span>
                          <div class='setting-input horizontal layout'>
                            <paper-input id='payload_disarm' value='{{alarm.attributes.mqtt.payload_disarm}}' placeholder='Payload Disarm'></paper-input>
                            <ha-icon-button data-type='input_text' data-setting='mqtt' data-attribute='payload_disarm' on-click='settingsSave' icon='mdi:check-circle-outline'></ha-icon-button>
                          </div>
                        </div>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-input horizontal layout'>
                          <span class='info-header'>Disarm Without Passcode:</span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.mqtt.override_code)}}' on-change='settingsSave' data-setting='mqtt' data-attribute='override_code'></ha-switch>
                        </div>
                        <span class='info-detail'>If enabled, allows MQTT command to disarm the alarm without a passcode.<br>Default: Disabled</span>
                      </div>

                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Pending On Warning:</span>
                          <ha-switch class='setting-toggle' checked='{{isChecked(alarm.attributes.mqtt.pending_on_warning)}}' on-change='settingsSave' data-setting='mqtt' data-attribute='pending_on_warning'></ha-switch>
                        </div>
                        <span class='info-detail'>Broadcast Pending state when the alarm is tripped instead of the default Warning state. This is to allow integration with other MQTT panels which use this state.<br>Default: Disabled</span>
                      </div>

                    </div>

                    <!-- ########################################################################### CUSTOM ##################################################################################################### -->
                    <div id='settings-custom' class='carousel-cell remove'>
                      <h1>Custom</h1>
                      <div class='setting-outer vertical layout'>
                        <div class='setting-inner horizontal layout'>
                          <span class='info-header'>Enable Custom Panel:</span>
                          <ha-switch class='setting-toggle' checked='{{alarm.attributes.panel.enable_custom_panel}}' on-change='settingsSave' data-setting='panel' data-attribute='enable_custom_panel'></ha-switch>
                        </div>
                        <span class='info-detail'>Enabling this allows you to add your own panel to this interface. For this to work see the template custom-element.html file. You will need to modify this with your own HTML code. Using this you could bring additional custom features of your own such as displaying extra information from Home Assistant or a 3rd party website. You could hook into external cameras or have a stocks and shared ticker.</span>
                      </div>
                    </div>

                    <!-- ########################################################################### HELP ##################################################################################################### -->
                    <!-- <div id='settings-help' class='carousel-cell remove'>
                      <h1>Help Guide</h1>
                      <div class='setting-outer vertical layout'>
                        <span class='info-detail'>This section is a work in progress. I'm knackered from just creating this interface, too many late nights :-D Let me know what you think would be good to display here. I'll likely provide the basics plus links to yaml automations and sample node-red files</span>
                      </div>
                    </div> -->

                  </div>
                </div>
              </div>
            </div>
<!--          </div>-->
        </div>

        <!-- ###########################################SELECTION BAR############################################### -->
        <div id='info-panel-selection'>
          <ha-icon-button icon='mdi:dialpad' title='Keypad' on-click='carouselClick' data-selection='controls'></ha-icon-button>
          <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_floorplan_panel)]]' >
            <ha-icon-button icon='mdi:floor-plan' title='Floorplan' on-click='carouselClick' data-selection='floorplan'></ha-icon-button>
          </template>
          <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_sensors_panel)]]' >
            <template is='dom-if' if='[[!isDisarmed(alarm)]]' >
              <template is='dom-if' if='[[!isChecked(alarm.attributes.panel.hide_sensors)]]' >
                <ha-icon-button icon='mdi:radio-tower' title='Alarm Sensors' on-click='carouselClick' data-selection='sensors' style$='color: [[computeButtonColor(opencount)]] !important;'></ha-icon-button>
              </template>
              <template is='dom-if' if='[[isChecked(alarm.attributes.panel.hide_sensors)]]' >
              </template>
            </template>
            <template is='dom-if' if='[[isDisarmed(alarm)]]' >
                <ha-icon-button icon='mdi:radio-tower' title='Alarm Sensors' on-click='carouselClick' data-selection='sensors' style$='color: [[computeButtonColor(opencount)]] !important;'></ha-icon-button>
            </template>
          </template>
          <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_camera_panel)]]' >
            <ha-icon-button icon='mdi:cctv' title='Cameras' on-click='carouselClick' data-selection='cameras'></ha-icon-button>
          </template>
          <template is='dom-if' if='[[isChecked(alarm.attributes.enable_log)]]' >
            <template is='dom-if' if='[[isDisarmed(alarm)]]' >
              <ha-icon-button icon='mdi:view-headline' title='Activity Log' on-click='carouselClick' data-selection='log'></ha-icon-button>
            </template>
          </template>
          <template is='dom-if' if='[[isChecked(alarm.attributes.panel.enable_custom_panel)]]' >
            <ha-icon-button icon='mdi:atom' title='Custom Panel' on-click='carouselClick' data-selection='custom'></ha-icon-button>
          </template>
          <template is='dom-if' if='[[isDisarmed(alarm)]]' >
            <ha-icon-button icon='mdi:tune' title='Settings' on-click='carouselClick' data-selection='set-login'></ha-icon-button>
          </template>
        </div>

        <!-- ###########################################CAMERA MODAL############################################### -->
        <div id="modalCamera">
          <img id="imgCamera" >
          <div id='captionCamera'></div>
        </div>

        <!-- ###########################################DONATE MODAL############################################### -->
        <div id='modalDonate'>
          <div id='donateMethod' class='info-header'></div>
          <div class='logo' style='padding-bottom: 20px;'></div>
          <div class='qr'></div>
          <div id='donateAddress' class='info-detail'></div>
        </div>

        <!-- ###########################################ERROR MODAL############################################### -->
        <template is='dom-if' if='[[items]]' >
          <div id='modalError' style='color: white'>
            <div class='horizontal layout'>
              <div id='error-icon'>
                <ha-icon icon='mdi:alert-circle-outline'></ha-icon>
              </div>
              <div>
                <div id='error-title'>This component is not working</div>
	              <!-- <div id='error-header'>Something went wrong with your alarm component!</div> -->
	              <template is='dom-repeat' items='[[items]]'>
	               <paper-item on-click='openLog'>
	                 <paper-item-body two-line>
	                   <div class="row">
	                     [[item.message]]
	                   </div>
	                   <div secondary>
	                     [[formatTime(item.timestamp)]] [[item.source]] ([[item.level]])
	                     <!-- [[formatTime(item.timestamp)]] this is not working --> ([[item.source]]) <!--([[item.level]]) it's always ERROR at the moment anyway -->
	                   </div>
	                 </paper-item-body>
	               </paper-item>
	              </template>

	              <div id='error-detail'>Check the Home Assistant log for more details.</div>

                <div id='error-version'>
                  <p><span class='info-detail'>This integration: </span><span class='info-header'>[[version]]</span></p>
                  <p><span class='info-detail'>Home Assistant: </span><span class='info-header'>v[[hass.config.version]]</span></p>
              </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </template>
  </dom-module>

  <script>
    {
      class HaPanelAlarm extends Polymer.Element {

        static get is(){ return 'ha-panel-alarm'; }

        static get properties(){
          return {
            hass:                 { type: Object },
            alarm:                { type: Object, observer: 'monitorAlarm' },
            platform:             { type: String, value: 'bwalarm' },
            resources_prefix:     { type: String },
            image_path:           { type: String },
            default_icon_name:    { type: String },
            default_icon_path:    { type: String },
            panel:                { type: Object },
            narrow:               { type: Boolean, value: false },
            showMenu:             { type: Boolean, value: false },

            settingsUnlock:       { type: Boolean, value: false },

            alarm_state:          { type: String, value: 'Disarmed'},
            panel_title:          { type: String, value: ''},

            carouselMainSelected: { type: Object },
            carouselSettings:     { type: Object },
            controls:             { type: Object },
            controlsLoaded:       { type: Boolean, value: false },

            attemptArmMode:       { type: String, value: ''},

            // Sensor Groups
            immediate:            { type: Array, computed: 'computeSensors(hass, alarm.attributes.immediate)' },
            delayed:              { type: Array, computed: 'computeSensors(hass, alarm.attributes.delayed)' },
            allsensors:           { type: Array, computed: 'computeSensors(hass, alarm.attributes.allsensors)'},
            ignored:              { type: Array, computed: 'computeSensors(hass, alarm.attributes.ignored)' },

            opencount:            { type: Number, value: 0 },

            time:                 { type: Object },
            weather:              { type: Object },
            temp:                 { type: String },

            code:                 { type: String, value: '' },
            display_code:         { type: String, value: '' },

            timeoutID:            { type: Number },

            sidebarTimerId:       { type: Number },

            cleanup:              { type: Array, value: [] },
            attemptedArm:         { type: Boolean, value: false },
            attemptedArmWithoutCode:         { type: Boolean, value: false },

            settings:             { type: Boolean, value: false },

            panel_locked:         { type: Boolean, value: false },

            cameraFeedSrc:        { type: String },
            camera_time:          { type: String },
            cameras:              { type: Array, value: [] },

            sensors:              { type: Array, value: [] },
            // internal ones, here to have them created only once instead of on every function call
            binary_sensors:       { type: Array, value: [] },
            switches:             { type: Array, value: [] },

            errors:               { type: Array },
            version:              { type: String, value: 'v1.12.14'},

            camera_update_interval: { type: Number, value: 5000 }, // ms

            settingColors:        { type: Array, value: [] },
            selectedUser:         { type: Object, value: null},

            viewport_width:       Number,
            viewport_height:      Number,

            // viewport orientation
            orientationLandscape: { type: Boolean },

            buttonsShape:         { type: String },  // valid options are: circle, square or rectangle
            buttonWidthToHeightRatio: { type: Number, computed: '_computeButtonWidthToHeightRatio(buttonsShape)'},

            // internal constants
            INT_ATTR_STATE_CHECK_BEFORE_ARM: { type: String, value: 'check_before_arm'},

            __mwc_button_wrapper_class: { type: String, value: "mdc-touch-target-wrapper"},
            __mwc_button__base_style: { type: String, value: "mdc-button mdc-button__ripple mdc-button--touch"},

            __mwc_button__outlined: { type: String, value: " mdc-button--outlined"},
            __mwc_button__raised: { type: String, value: " mdc-button--raised"},
          }
        }

        _computeButtonWidthToHeightRatio(buttonsShape) {
          if (buttonsShape != undefined) {
            switch(buttonsShape) {
              case 'circle':
              case 'square':
                return 1;

              case 'rectangle':
                return 2;

              default:
                console.error('_computeButtonWidthToHeightRatio: invalid parameter ' + buttonsShape);
            }
          }
          else {
            console.error('_computeButtonWidthToHeightRatio: buttonsShape undefined, returning 0');
            return 0;
          }
        }

        // Polymer observers definition
        static get observers() {
          return [
            'onPanelUpdate(hass, panel)',
            'updateTime(hass)',
            '_round_buttons(alarm.attributes.panel.round_buttons)',
            '_code_to_arm(alarm.attributes.code_arm_required)',
            '_viewport_changed(viewport_height, viewport_width)'
          ]
        }

        _viewport_changed(viewport_height, viewport_width) {
          this._updateButtonsStyles();
        }

        _code_to_arm(code_arm_required) {
          this._updateButtonsStyles();
        }

        _round_buttonsTobuttonsShape(round_buttons) {
          // temporarily!
          if ( this.isChecked(round_buttons) )
            this.buttonsShape = 'circle';
          else
            this.buttonsShape = 'rectangle'; // should be square!
          console.log('_round_buttonsTobuttonsShape: round_buttons=' + round_buttons + ' => buttonsShape=' + this.buttonsShape);
        }

        _round_buttons(round_buttons) {
          console.log('_round_buttons: ' + round_buttons);
          this._round_buttonsTobuttonsShape(round_buttons);
          this._updateButtonsStyles();
        }

        connectedCallback() {
          super.connectedCallback();
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          clearInterval(this.camTimer);
        }

        //Page ready
        ready(){
          console.log('ready()');
          super.ready();

          // Check the alarm component successfully loaded if not then display an error
          if (this.alarm){
            // TODO!!
            this.platform = this.alarm.attributes.platform;
            this.resources_prefix = "/" + this.platform + "/";
            // TODO: replace hardcoded "images/"
            this.image_path = this.resources_prefix + "images/";
            this.default_icon_name = this.alarm.attributes.default_icon_name;
            this.default_icon_path = this.image_path + this.default_icon_name;
            //console.log("platform: ", this.platform);
            //console.log("resources_prefix: ", this.resources_prefix);
            //console.log("image_path: ", this.image_path);
            //console.log("default_icon_path: ", this.default_icon_path);

            //Countdown360
            var script = document.createElement('script');
            var c360 = this.resources_prefix + 'lib/countdown360.js';
            //console.log("c360: ", c360);
            script.setAttribute('src', c360);
            document.body.appendChild(script);

            this.loadSettings();

            this.controls = this.$.controls;

            if (this.isChecked(this.alarm.attributes.hide_sidebar))  this.closeSidebar();

            //Determine screensize and set appropriate controls
            this.setupUI();

            this._loadData();
          }
          // Display the error
          else {
            console.log("This integration is broken. Check your Home Assistant error log");
            this.updating = true;
            this.hass.callApi("get", "error/all").then((items) => {
              this.errorItems = items;
              this.updating = false;
              this.items = [];
              for (var item in this.errorItems) {
                if (this.errorItems[item].level.includes("ERROR") && this.errorItems[item].message.includes(this.platform)) {
                  this.items.push(this.errorItems[item]);
                }
              }
            });
          }
        }

        getKeys(obj){
          if (obj != null) {
            return Object.keys(obj);
          }
          else return false;
        }

        defineColors(ev){

          this.unhideDiv('#themeDetail');

          var theme = null;

          if (ev != null){
            ev.stopPropagation();

            var themeName =  ev.target.getAttribute('data-theme');

            if (this.alarm.attributes.themes)
              for (var x in this.alarm.attributes.themes)
                if (this.alarm.attributes.themes[x].name == themeName){
                  theme = this.alarm.attributes.themes[x];
                  this.shadowRoot.querySelector('#theme-name').value = themeName;
                  this.shadowRoot.querySelector('#theme-name-button').setAttribute('name', themeName);
                }
          }

          this.settingColors = [{}];

          this.settingColors[0] = {
            'name':'warning_color', 'header':'Warning', 'theme':themeName,
            'description':'If a sensor is tripped when the alarm is armed the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.warning_color != null) ? theme.warning_color : 'black'};

          this.settingColors[1] = {
            'name':'pending_color', 'header':'Pending', 'theme':themeName,
            'description':'When the alarm is arming the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.pending_color != null) ? theme.pending_color  : 'black'};

          this.settingColors[2] = {
            'name':'disarmed_color', 'header':'Disarmed', 'theme':themeName,
            'description':'When the alarm is disarmed the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.disarmed_color != null) ? theme.disarmed_color : 'black'};

          this.settingColors[3] = {
            'name':'triggered_color', 'header':'Triggered', 'theme':themeName,
            'description':'When the alarm has been triggered the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.triggered_color != null) ? theme.triggered_color : 'black'};

          this.settingColors[4] = {
            'name':'armed_home_color', 'header':'Armed in \'Home\' Mode', 'theme':themeName,
            'description':'When the alarm is set in \'Home Mode\' the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.armed_home_color != null) ? theme.armed_home_color : 'black'};

          this.settingColors[5] = {
            'name':'armed_away_color', 'header':'Armed in \'Away\' Mode', 'theme':themeName,
            'description':'When the alarm is set in \'Away Mode\' the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.armed_away_color != null) ? theme.armed_away_color : 'black'};

          this.settingColors[6] = {
            'name':'armed_night_color', 'header':'Armed in \'Night\' Mode', 'theme':themeName,
            'description':'When the alarm is set in \'Night Mode\' the panel will display this color in both the top header background and the centre panel background',
            'color': (theme != null && theme.armed_night_color != null) ? theme.armed_night_color  : 'black'};

          this.settingColors[7] = {
            'name':'panel_background_color', 'header':'Panel Background', 'theme':themeName,
            'description':'The background color of the main content section.',
            'color': (theme != null && theme.panel_background_color != null) ? theme.panel_background_color  : 'black'};

          this.settingColors[8] = {
            'name':'panel_outer_background_color', 'header':'Panel Outer Background', 'theme':themeName,
            'description':'The background color of both the status bar and the menu bar.',
            'color': (theme != null && theme.panel_outer_background_color != null) ? theme.panel_outer_background_color  : 'black'};

          this.settingColors[9] = {
            'name':'panel_text_color', 'header':'Panel Text', 'theme':themeName,
            'description':'The color of the general text within the panel.',
            'color': (theme != null && theme.panel_text_color != null) ? theme.panel_text_color  : 'black'};

          this.settingColors[10] = {
            'name':'header_background_color', 'header':'Header Background', 'theme':themeName,
            'description':'The background color of very top header bar.',
            'color': (theme != null && theme.header_background_color != null) ? theme.header_background_color  : 'black'};

          this.settingColors[11] = {
            'name':'header_text_color', 'header':'Header Text', 'theme':themeName,
            'description':'The text color on very top header bar.',
            'color': (theme != null && theme.header_text_color != null) ? theme.header_text_color  : 'black'};

          this.settingColors[12] = {
            'name':'alarmstatus_text_color', 'header':'Alarm Status Text', 'theme':themeName,
            'description':'The text color of the Alarm Status.',
            'color': (theme != null && theme.alarmstatus_text_color != null) ? theme.alarmstatus_text_color : 'black'};

          this.settingColors[13] = {
            'name':'time_text_color', 'header':'Time Text', 'theme':themeName,
            'description':'The text color of the Time label.',
            'color': (theme != null && theme.time_text_color != null) ? theme.time_text_color  : 'black'};

          this.settingColors[14] = {
            'name':'weather_text_color', 'header':'Weather Text', 'theme':themeName,
            'description':'The text color of the Weather label.',
            'color': (theme != null && theme.weather_text_color != null) ? theme.weather_text_color  : 'black'};

          this.settingColors[15] = {
            'name':'weather_image_color', 'header':'Weather Image', 'theme':themeName,
            'description':'The color of the Weather image.',
            'color': (theme != null && theme.weather_image_color != null) ? theme.weather_image_color  : 'black'};

          this.settingColors[16] = {
            'name':'info_header_text_color', 'header':'Information Header Text', 'theme':themeName,
            'description':'The color of the Heading within a particular Section.',
            'color': (theme != null && theme.info_header_text_color != null) ? theme.info_header_text_color  : 'black'};

          this.settingColors[17] = {
            'name':'info_detail_text_color', 'header':'Information Detail Text', 'theme':themeName,
            'description':'The color of the descriptive text within a particular Section.',
            'color': (theme != null && theme.info_detail_text_color != null) ? theme.info_detail_text_color  : 'black'};

          this.settingColors[18] = {
            'name':'title_text_color',   'header':'Title (Content) Text', 'theme':themeName,
            'description':'The color of the Title text within a particular section.',
            'color': (theme != null && theme.title_text_color!= null) ? theme.title_text_color  : 'black'};

          this.settingColors[19] = {
            'name':'subtitle_text_color', 'header':'Subtitle (Content) Text', 'theme':themeName,
            'description':'The color of the Subtitle text within a particular section.',
            'color': (theme != null && theme.subtitle_text_color!= null) ? theme.subtitle_text_color  : 'black'};

          this.settingColors[20] = {
            'name':'openSensors_title_color', 'header':'Open Sensors Title', 'theme':themeName,
            'description':'The color of the Open Sensors Title to draw attention to the open sensor.',
            'color': (theme != null && theme.opensensors_title_color != null) ? theme.opensensors_title_color  : 'black'};

          this.settingColors[21] = {
            'name':'button_background_color', 'header':'Button Background Color', 'theme':themeName,
            'description':'The background color of the alarm buttons.',
            'color': (theme != null && theme.button_background_color != null) ? theme.button_background_color  : 'black'};

          this.settingColors[22] = {
            'name':'cancel_color',   'header':'Cancel Button Background', 'theme':themeName,
            'description':'The background color of the cancel button.',
            'color': (theme != null && theme.cancel_color != null) ? theme.cancel_color  : 'black'};

          this.settingColors[23] = {
            'name':'override_color', 'header':'Override Button Background', 'theme':themeName,
            'description':'The background color of the override button.',
            'color': (theme != null && theme.override_color != null) ? theme.override_color  : 'black'};

          this.settingColors[24] = {
            'name':'info_panel_buttons_color', 'header':'Menu Buttons', 'theme':themeName,
            'description':'The color of the menu buttons.',
            'color': (theme != null && theme.info_panel_buttons_color != null) ? theme.info_panel_buttons_color : 'black'};

          this.settingColors[25] = {
            'name':'arm_button_border_color', 'header':'Alarm Button Border', 'theme':themeName,
            'description':'The border color of the alarm buttons.',
            'color': (theme != null && theme.arm_button_border_color != null) ? theme.arm_button_border_color  : 'black'};

          this.settingColors[26] = {
            'name':'arm_button_text_color', 'header':'Alarm Button Text', 'theme':themeName,
            'description':'The color of the text within the alarm buttons.',
            'color': (theme != null && theme.arm_button_text_color != null) ? theme.arm_button_text_color  : 'black'};

          this.settingColors[27] = {
            'name':'paper_listbox_background_color', 'header':'Listbox background', 'theme':themeName,
            'description':'The background color of the listboxes.',
            'color': (theme != null && theme.paper_listbox_background_color != null) ? theme.paper_listbox_background_color  : 'black'};

          this.settingColors[28] = {
            'name':'paper_listbox_color', 'header':'Listbox text', 'theme':themeName,
            'description':'The text color within the listboxes.',
            'color': (theme != null && theme.paper_listbox_color != null) ? theme.paper_listbox_color : 'black'};

          this.settingColors[29] = {
            'name':'paper_item_selected___color', 'header':'Item Selected', 'theme':themeName,
            'description':'The text color of the item selected within a selection box.',
            'color': (theme != null && theme.paper_item_selected___color != null) ? theme.paper_item_selected___color  : 'black'};

          this.settingColors[30] = {
            'name':'action_button_border_color', 'header':'Action button border', 'theme':themeName,
            'description':'The color of the border surrounding the action buttons',
            'color': (theme != null && theme.action_button_border_color != null) ? theme.action_button_border_color  : 'black'};

          this.addColorPicker();
        }

        addColorPicker(){
          setTimeout(function(instance) {
            var colorPickers = instance.shadowRoot.querySelectorAll('.colPicker');

            for (var i = 0; i <= colorPickers.length - 1; i++) {
              var input = document.createElement('INPUT');
              input.id = colorPickers[i].id.replace('_span','');
              var picker = new jscolor(input)
              picker.fromString(colorPickers[i].value);

              //clear previous pickers
              while (colorPickers[i].firstChild)
                colorPickers[i].removeChild(colorPickers[i].firstChild);

              //var clearBox = colorPickers[i];
              if (colorPickers[i] != null)
                colorPickers[i].appendChild(input);
            }
            instance.setCarouselHeight(instance.carouselMainSelected);
          }, 200, this);
        }

        toUpper(text){
          return text.charAt(0).toUpperCase() + text.slice(1);
        }

        unhideDiv(ev){
          var el = null;
          if (ev.target) el = ev.target.getAttribute('data-div');
          else el = ev;
          var element = this.shadowRoot.querySelector(el);
          if (element) element.classList.remove('remove');
          //this.setCarouselHeight(this.carouselMainSelected);
        }

        hideDiv(ev){
          var el = null;
          if (ev.target) el = ev.target.getAttribute('data-div');
          else el = ev;
          var element = this.shadowRoot.querySelector(el);
          if (element) element.classList.add('remove');
          //this.setCarouselHeight(this.carouselMainSelected);
        }

        updateTheme(){
          if (this.alarm.attributes.themes)
            for (var x in this.alarm.attributes.themes)
              if (this.isChecked(this.alarm.attributes.themes[x].active)){

                var theme = this.alarm.attributes.themes[x];
                if (typeof theme.name == 'string'){
                  var styles = {};
                  for (var cssVar in theme){
                    if (cssVar != 'name' && cssVar != 'active'){
                      var style = '--' + cssVar.replace(new RegExp('_', 'g'), '-');
                      styles[style] = this.alarm.attributes.themes[x][cssVar];
                    }
                  }
                  this.updateStyles(styles);
                  var color = styles['--' + this.alarm.state.replace(new RegExp('_', 'g'), '-') + '-color'];
                  if (color)
                    this.updateStyles({'--panel-outer-background-color': color});
                }
              }
        }

        // Log an error
        error(message){
          if (this.errors == null) this.errors = [];
          this.errors.push(message);
          console.log(message);
        }

        exists(entity){
          if (entity) return true;
          else return false;
        }

        getObject(entity){
          return this.hass.states[entity];
        }

        getPanelTitle(){
          if (this.alarm && this.alarm.attributes.panel && this.alarm.attributes.panel.panel_title != null )
            this.panel_title = this.alarm.attributes.panel.panel_title.trim();
        }

        // returns combined (title and state) status
        // depending on title and status content
        _alarmStatus(state, title) {
          // if state starts with _ - don't prefix it with anything
          if (state.match(/^_.+/))
            return state.slice(1);
          // if it's a number - they're disarming
          // prefix with title if it isn't empty
          else {
            var prefix = state.match(/\d+/)? (this.isDisarmed(this.alarm)? 'Arm with ' : 'Disarm with ') : (title.length? title + ': ' : '');
            return prefix + state;
          }
        }

        isChecked(arg){
          // original code
          //if (arg == 'True' || arg == true) return true;
          //else return false;

          // code that supports booleans, their case-insensitive string equvivalents or numbers
          // similar to homeassistant/helpers/config_validation: boolean
          // but does not throw exceptions considering anything else as false (for example, undefined)
          if (typeof arg == "boolean") return arg;

          if (typeof arg == "string") {
            var lc_arg = arg.toLowerCase();
            // returns true on "1", "true", "yes", "on" and "enable" and false on anything else
            return (lc_arg == "1" || lc_arg == "true" || lc_arg == "yes" || lc_arg == "on" || lc_arg == "enable");
          } else if (typeof arg == "number")
            return arg !=0;

          return false;
        }

        computeJSONValue(entity, attribute){
             if (entity == undefined){
              return false;
          } else {
            var obj = JSON.parse(entity);
              return obj[attribute];
          }
        }

        computeValueArray(entity, attribute){
             if (entity == undefined){
              return false;
          } else {
              return entity[attribute];
          }
        }

        computeValueArray(entity, attribute, attribute2){
             if (entity == undefined){
              return false;
          } else {
              return entity[attribute][attribute2];
          }
        }

        loadSettings(){
          this.sensors = [];
          this.binary_sensors = [];
          this.switches = [];

          for (var state in this.hass.states) {
            if (state.split('.')[0] == 'camera'){ //find all cameras and add to array
              this.cameras.push(state);
            }
            else if (state.split('.')[0] == 'sensor'){
              this.sensors.push(state);
            }
            else if (state.split('.')[0] == 'binary_sensor'){
              this.binary_sensors.push(state);
            }
            else if (state.split('.')[0] == 'switch'){
              this.switches.push(state);
            }
          }
         this.binary_sensors.sort();
         this.switches.sort();
         this.sensors.sort();
         this.sensors.push.apply(this.sensors, this.binary_sensors);
         this.sensors.push.apply(this.sensors, this.switches);
        }

        computeLog(entry, type){
          switch (type){
            case 'time':
              var t = new Date(entry[0] * 1000);
              return t.toLocaleString('en-GB').split(",")[1] + " - " + t.toLocaleString('en-GB').split(",")[0];

            case 'name':
              // if it's error message, sometimes we don't need a name
              if ((entry[2] == 1) || (entry[2] == 2) || (entry[2] == 5) || (entry[2] == 6))
                return;
              for (var user in this.alarm.attributes.users) {
                if (this.alarm.attributes.users[user]['id'] == entry[1])
                  return this.toUpper(this.alarm.attributes.users[user]['name']);
              }
              return this.toUpper(entry[1]);

            case 'image':
              // if it's error message, sometimes we don't need a badge
              if ((entry[2] == 1) || (entry[2] == 2) || (entry[2] == 5) || (entry[2] == 6))
                return;
              for (var user in this.alarm.attributes.users) {
                if (this.alarm.attributes.users[user]['id'] == entry[1]){
                  //console.log("computeLog(%s, %s) = %s", entry[1], type, this.image_path + this.alarm.attributes.users[user]['picture']);
                  return this.image_path + this.alarm.attributes.users[user]['picture'];
                }
              }
              return this.default_icon_path;

            case 'message':
              switch (entry[2]){
                case 0: return 'disarmed the alarm';
                case 1: return 'Disarm attempt failed, wrong passcode';
                case 2: return 'Alarm has been triggered by ' + this.computeFriendlyName(entry[3]);
                case 3: return 'set the alarm in Home mode';
                case 4: return 'set the alarm in Away mode';
                case 5: return 'Alarm has been tripped by ' + this.computeFriendlyName(entry[3]);
                case 6: return 'Panel Locked';
                case 8: return 'set the alarm in Night mode';
              }
              var err = "unknown message \"" + entry[2] + "\"";
              console.log("computeLog: ", err);
              return err;
          }
        }

        compareString(str1, str2){
          return true ? str1 == str2 : false;
        }

        //Check the admin password to grant access to the settings tab
        checkSettingsPassword(){
          //Get the password dom
          var passwordInput = this.$.passwordInput;

          //Calculate the SHA256 hash of the input
          var passwordHash = this.passwordToHash($(passwordInput).val());

          //If it matches the stored hash then grant access
          if (passwordHash == this.alarm.attributes.admin_password){
          //Password matches so load settings cell
            this.settingsUnlock = true;
            this.carouselChange(this.shadowRoot.querySelector('#settings-info'));

            //Clear password input
            $(passwordInput).val('');
          }
        }

        //Return a sha2656 Hash from the input string
        passwordToHash(password){
          return sha256_digest(password);
        }

        _updateViewportProperties() {

          var viewport_width = $(window).width();
          var viewport_height = $(window).height();
          var orientationLandscape = viewport_width > viewport_height;
          // instead of var orientationLandscape = window.matchMedia("(orientation: landscape)").matches;

          if ((this.viewport_width == undefined) || (this.viewport_height == undefined) || (this.viewport_width != viewport_width) || (this.viewport_height != viewport_height)) {
            console.log("_updateViewportProperties(): " + viewport_width.toString() + "x" + viewport_height.toString() + ', orientationLandscape=' + orientationLandscape);
            this.viewport_width = viewport_width;
            this.viewport_height = viewport_height;
            this.orientationLandscape = orientationLandscape;
          }
        }

        //Determine the screen size then set the appropriate UI
        setupUI(){
          console.log("setupUI");

          this._updateViewportProperties();

          if (this.alarm.attributes.panel == null) {
            this.alarm.attributes.panel = {};
            this.settingsUpdate('panel', {});
          }

          this._updateButtonsStyles();

          if (this.alarm.attributes.panel.cameras == null) {
            var panel = this.alarm.attributes.panel;
            panel.cameras = [];
            this.settingsUpdate('panel', panel);
          }

          if (this.alarm.attributes.states == null) {
            var states = {
              'armed_away' : {'immediate':[], 'delayed':[], 'override':[], 'pending_time': 0, 'warning_time': 0, 'trigger_time': 600},
              'armed_home' : {'immediate':[], 'delayed':[], 'override':[], 'pending_time': 0, 'warning_time': 0, 'trigger_time': 600},
              'armed_night' : {'immediate':[], 'delayed':[], 'override':[], 'pending_time': 0, 'warning_time': 0, 'trigger_time': 600}
            };
            this.settingsUpdate('states', states);
          }

          if (this.alarm.attributes.panel.camera_update_interval > 0) this.camera_update_interval = this.alarm.attributes.panel.camera_update_interval * 1000;

          this.camTimer = setInterval(() => this.updateCameraTime(), this.camera_update_interval);

          if (this.isChecked(this.alarm.attributes.panel.enable_weather))
            this.getWeather();

          //setupCameras
          setTimeout(this.setupCameras, 5000, this.shadowRoot);

          this.setupDt();

          // Screen less than 1200 px
          if ($(window).height() < 600) {
            this.updateStyles({'--shadow-effect': 'unset'});
  /*          if (!this.controlsLoaded) {
              //Add the keypad and controls to the carousel
                this.controlsLoaded = true;
            }*/
          }
          else {
            if (this.isChecked(this.alarm.attributes.panel.shadow_effect)) this.updateStyles({'--shadow-effect': 'below 0 linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, .1))'});
            else this.updateStyles({'--shadow-effect': 'unset'});
  /*          //Remove the keypad and controls to the carousel
            this.controlsLoaded = false;*/
          }

          if ( ($(window).width() > 767) && this.alarm.attributes.panel)
            this.weatherTimer = setInterval(() => this.updateWeatherSVG(), 500);

          this.carouselMainSelected = this.$.carousel_template;
          this.carouselChange(this.$.controls);
        }

        updateWeatherSVG() {
          if (this.shadowRoot.querySelector('#weather_svg')) {
            if (this.shadowRoot.querySelector('#weather_svg').getSVGDocument() != null){
              this.shadowRoot.querySelector('#weather_svg').getSVGDocument().querySelectorAll('svg')[0].setAttribute("fill", window.getComputedStyle(this.shadowRoot.querySelector('#weather-icon')).getPropertyValue("fill"));
              clearInterval(this.weatherTimer);
            }
          }
        }

        setupDt(){
          // Get the modal
          var modalDT = this.shadowRoot.querySelector('#modalDonate');
          var dtMethod = this.shadowRoot.querySelector('#donateMethod');
          var dtAddress = this.shadowRoot.querySelector('#donateAddress');

          // Get the image and insert it inside the modal
          var dt = this.shadowRoot.querySelectorAll(".donate");

          for (var i = 0; i < dt.length; i++) {
              dt[i].onclick = function(){
                modalDT.className = "";
                modalDT.style.display = "block";
                modalDT.classList.add(this.id);

                dtMethod.innerHTML = this.querySelector('.info-header').innerHTML;
                dtAddress.innerHTML = this.getAttribute('data-address');
              }
          }
          // When the user clicks on camera, close the modal
          modalDT.onclick = function() {
            modalDT.style.display = "none";
          }
        }

        //One of the menu buttons has been clicked so show the appropriate tab
        carouselClick(ev){
          ev.stopPropagation();

          //Get the selection
          var selection = ev.target.getAttribute('data-selection');
          //console.log("carouselClick: ", selection);

          //If the selection is not a settings item then lockup the settings lab
          if (!selection.includes('settings'))
            this.settingsUnlock = false;

          //Show the selected tab
          this.carouselChange(this.shadowRoot.querySelector('#' + selection));
        }

        //Show the newly selected tab
        carouselChange(carouselCell){
          var FNAME = '[carouselChange] '
          if (typeof this.carouselMainSelected == 'undefined') {
            //console.log(FNAME, "carouselMainSelected in undefined, return");
            return;
          }

          //console.log(FNAME, "carouselMainSelected = ", this.carouselMainSelected, "carouselCell = ", carouselCell);
          if (this.carouselMainSelected != carouselCell){
            //Remove the current cell
            this.carouselMainSelected.classList.add('remove');
            carouselCell.classList.remove('remove');
            this.carouselMainSelected.classList.remove('carousel-slide-in');
            setTimeout(function(carouselCell) {carouselCell.classList.add('carousel-slide-in');}, 100, carouselCell);

            //Update the master selected cell for later use
            this.carouselMainSelected = carouselCell;
            //console.log(FNAME, "carouselMainSelected changed", carouselCell);
          }
        }

        //Setup the camera clicks and modal
        setupCameras(root) {
          // Get the modal
          var modalCamera = root.querySelector('#modalCamera');

          // Get the image and insert it inside the modal - use its "alt" text as a caption
          var camera = root.querySelectorAll(".camera");

          var imgCamera = root.querySelector('#imgCamera');
          var captionText = root.querySelector('#captionCamera');

          for (var i = 0; i < camera.length; i++) {
            var cam = camera[i];
              camera[i].onclick = function(){
                modalCamera.style.display = "block";
                imgCamera.src = this.src;
                captionText.innerHTML = this.alt;
              }
          }
          // When the user clicks on camera, close the modal
          modalCamera.onclick = function() {
            modalCamera.style.display = "none";
          }
        }

        //Updates camera time
        updateCameraTime() {
          this.camera_time = (new Date()).getTime();
        }

        //Get the latest camera snapshop
        updateCameraFeedSrc(camera, camera_time) {
          if (this.hass.states[camera] == null) return '';
          var attr = this.hass.states[camera].attributes;
          return attr.entity_picture + '&time=' + camera_time;
        }

        // Close the sidebar if alarm is set and the option is enabled
        closeSidebar(instance){
          if ( instance.alarm && !instance.isDisarmed(instance.alarm) )
            instance.fire('hass-close-menu');
        }

        entityTapped(ev){
          ev.stopPropagation();
          this.fire('hass-more-info', { entity_id: ev.target.getAttribute('data-entity')});
        }

        //Monitors the alarm status for any changes
        monitorAlarm(){
          console.log("monitorAlarm");

          this.callclearcode(null);

          var themeName = null;

          this.opensensors(this.alarm, this.allsensors);

          this.updateStyles({'--panel-outer-background-color': ''});

          this.updateTheme();

          if (this.alarm.attributes.panel) {
            this.getPanelTitle();
            this.updatePanelStyles();
          }

          //Resets countdown display
          if (!this.isPending(this.alarm) && this.$.countdown.querySelector('#countdown360'))
            this.$.countdown.querySelector('#countdown360').remove();

          this.updateStyles({'--countdown-timer-display': 'none'});
          this.updateStyles({'--time-display': 'initial'});

          if (this.isDisarmed(this.alarm)){
            if ((this.attemptedArm == true) || (this.attemptedArmWithoutCode == true)) this.resetUI();

          } else if (this.isPending(this.alarm)){
            this.updateStyles({'--countdown-timer-display': 'initial'});
            this.updateStyles({'--time-display': 'none'});
            this.loadUITimer(false, this.alarm.attributes.states[this.alarm.attributes.arm_state].pending_time);

          } else if (this.isWarning(this.alarm)){
            this.updateStyles({'--countdown-timer-display': 'initial'});
            this.updateStyles({'--time-display': 'none'});
            this.loadUITimer(false, this.alarm.attributes.states[this.alarm.attributes.arm_state].warning_time);
          }

          if (this.alarm.attributes.panel_locked == true){
            console.log('Panel locked');
            this.updateStyles({'--primary-color': 'grey'}); //[TODO] Implement panel locked color - this.alarm.attributes.colors['panel_locked});
            this.updateStyles({'--countdown-timer-display': 'initial'});
            this.updateStyles({'--time-display': 'none'});
            this.loadUITimer(true, this.alarm.attributes.passcode_attempts_timeout);
            this.panel_locked = true;
          }
          else this.panel_locked = false;

          if (!this.isDisarmed(this.alarm)) {
            // show keypad in every instance to avoid settings changes
            //console.log("monitorAlarm: set settingsUnlock to false as alarm is armed");
            this.settingsUnlock = false;
            //console.log("monitorAlarm: call carouselChange to make sure Settings is not displayed");
            this.carouselChange(this.$.controls);
          }

          // add handler to remove shake effect (otherwise it shakes only once)
          const content = this.$.content;
          if (content){
            content.addEventListener("animationend", (e) => {
              content.classList.remove("shake");
            });
          }
        }

        // calculate and set buttons' width and height according to screen size and options enabled
        _updateButtonsStyles() {
          if (this.buttonsShape === undefined) {
            console.log('_updateButtonsStyles: buttonsShape undefined, returning');
            return;
          }

          if ((this.viewport_width === undefined) || (this.viewport_height === undefined)) {
            console.log('_updateButtonsStyles: viewport not initialized, returning');
            return;
          }

          if (this.alarm === undefined) {
            console.log('_updateButtonsStyles: alarm not initialized, returning');
            return;
          }

          console.log('_updateButtonsStyles: buttonsShape=' + this.buttonsShape);
          var button_shape = (this.buttonsShape == 'circle')? '50%' : '4px';
          var symmetric_button = (this.buttonsShape == 'rectangle')? false : true;

          var min_dimension = Math.min(this.viewport_width, this.viewport_height);
          var code_arm_required = this.isChecked(this.alarm.attributes.code_arm_required);
          var width_to_height_ratio = this.buttonWidthToHeightRatio;

          // vh of arm buttons depending on code_arm_required (as we have less space on disarmed screen when code required)
          var arm_button_width_percentage = code_arm_required? 18 : 30;
          var arm_button_width = Math.trunc((arm_button_width_percentage*min_dimension)/100);
          var arm_button_height = symmetric_button? arm_button_width : Math.trunc(arm_button_width/width_to_height_ratio); // same for symmetric buttons (circle/square) and half of it for rectangle

          var message_button_width = 115;
          var message_button_height = symmetric_button? message_button_width : Math.trunc(message_button_width/width_to_height_ratio);

          var available_width = this.viewport_width;
          var status_bar_height = 87;
          var info_panel_height = status_bar_height;

          // subtract hardcoded heights: --status-bar-height and --info-panel-height : and margins
          var available_height = this.viewport_height - status_bar_height - info_panel_height;

          var top_margin = code_arm_required? 5 : 15; // margins at and bottom
          var bottom_margin = top_margin; // margins and bottom
          var left_margin = this.orientationLandscape? 5 : 15; // left margin
          var right_margin = left_margin; // right margin

          var button_top_bottom_margin = (min_dimension < 768)? 4: 5;
          var button_left_right_margin = (min_dimension < 768)? 5: 10;

          var arm_button_top_bottom_margin = (min_dimension < 768)? 5: 10;
          var arm_button_left_right_margin = arm_button_top_bottom_margin;

          var arm_buttons = this.isChecked(this.alarm.attributes.enable_night_mode)? 3 : 2;

          var horizontalCodepanel = this.needHorizontalCodepanel(this.orientationLandscape, this.alarm.attributes.code_arm_required);
          var buttons_in_row = horizontalCodepanel? 4 : 3;
          var buttons_in_column = horizontalCodepanel? 3 : 4;

          console.log('_updateButtonsStyles: min_dimension=' + min_dimension + ', available ' + available_width + 'x' + available_height + ', horizontalCodepanel=' + horizontalCodepanel + ', buttons_in_row=' + buttons_in_row + ', buttons_in_column=' + buttons_in_column + 'arm_buttons=' + arm_buttons);

          var button_width;
          var button_height;
          var max_button_width = (available_width - left_margin - buttons_in_row*2*button_left_right_margin - right_margin)/buttons_in_row;

          if (symmetric_button) {
            var arm_button_total_height = code_arm_required? (2*arm_button_top_bottom_margin + arm_button_height) : 0; // don't take into account arm buttons' height if no code to arm required
            var max_button_height = (available_height - top_margin - buttons_in_column*2*button_top_bottom_margin - arm_button_total_height - bottom_margin)/buttons_in_column;

            // use min as it will surely not exceed the viewport
            button_width = Math.trunc(Math.min(max_button_height, max_button_width));
            button_height = button_width;
          }
          else {
            button_width = Math.min(max_button_width, arm_button_width); // to avoid too wide codepanel buttons
            button_height = arm_button_height;
          }

          // apply computed styles

          function _numberToPx(num) {
            return num.toString() + 'px';
          }

          var styles = {};
          // change shape of all buttons
          styles['--button-shape'] = button_shape;

          // set codepanel buttons' size and margins
          console.log('_updateButtonsStyles: convert button ' + Math.trunc(max_button_width) + 'x' + Math.trunc(max_button_height) + 'px into a ' + this.buttonsShape + ' of ' + button_width + 'x' + button_height + 'px with margins ' + _numberToPx(button_top_bottom_margin) + '; ' + button_left_right_margin.toString() + 'px');
          styles['--button-height'] = _numberToPx(button_height);
          styles['--button-width'] = _numberToPx(button_width);
          styles['--button-top-bottom-margin'] = _numberToPx(button_top_bottom_margin);
          styles['--button-left-right-margin'] = _numberToPx(button_left_right_margin);

          // set arm buttons' size and margins
          console.log('_updateButtonsStyles: set arm buttons to ' + arm_button_width.toString() + 'x' + arm_button_height.toString() + 'px with margins ' + _numberToPx(arm_button_top_bottom_margin) +'; ' + _numberToPx(arm_button_left_right_margin));
          styles['--arm-button-height'] = _numberToPx(arm_button_height);
          styles['--arm-button-width'] = _numberToPx(arm_button_width);
          styles['--arm-button-top-bottom-margin'] = _numberToPx(arm_button_top_bottom_margin);
          styles['--arm-button-left-right-margin'] = _numberToPx(arm_button_left_right_margin);

          // set error/warning messages' buttons' size and margins
          console.log('_updateButtonsStyles: set message buttons to ' + message_button_width.toString() + 'x' + message_button_height.toString() + 'px with margins ' + _numberToPx(button_top_bottom_margin) + '; ' + _numberToPx(button_left_right_margin));
          styles['--message-button-height'] = _numberToPx(message_button_height);
          styles['--message-button-width'] = _numberToPx(message_button_width);
          styles['--message-button-margin'] = '20px';

          this.updateStyles(styles);
        }

        updatePanelStyles(){
          console.log('updatePanelStyles');
          //Re-aligns title bar
//          var title = this.shadowRoot.querySelector('#main-title-text');
//          if (title){
//            if (this.alarm.attributes.panel != null && (this.isDisarmed(this.alarm) || !this.isChecked(this.alarm.attributes.panel.hide_sidebar)))
//              title.classList.add('margin-left');
//            else
//              title.classList.remove('margin-left');
//          }

          //this._updateButtonsStyles();

          if (this.isChecked(this.alarm.attributes.panel.hide_sidebar)){
            clearInterval(this.sidebarTimerId);
            // Close the sidebar if alarm is set and the option is enabled
            this.sidebarTimerId = setInterval(this.closeSidebar, 100, this);
          }

          if (this.isChecked(this.alarm.attributes.panel.enable_serif_font)) this.updateStyles({'--font-header': "'Lobster'"});
          else this.updateStyles({'--font-header': "unset"});
        }

        // Loads the count down timer when arming the alarm
        loadUITimer(locked, time){
          var startColor = '#8ac575';
          var middleColor = 'orange';
          var endColor = 'red'

          if (locked == true) startColor = middleColor = endColor = 'red';

          var countdownDiv = this.$.countdown;

          $(countdownDiv).empty();
          $(countdownDiv).unbind().removeData();

          var countdown = $(countdownDiv).countdown360(
          {
            radius      : 35,
            fontColor   : '#FFFFFF',
            autostart   : false,
            label       : false,
            smooth      : true,
            seconds     : time,
            fillStyle_0to50: startColor,
            fillStyle_50to75: middleColor,
            fillStyle_75to100: endColor
          });
          countdown.start();
        }

        // Gets the weather to display if enabled
        getWeather(){
          this.weather = this.hass.states['sensor.weather_summary'];

          //if the above sensor can't be found then try dark_sky
          if (this.weather == null)
            this.weather = this.hass.states['sensor.dark_sky_summary'];

          //No weather entity found display error
          if (this.weather == null)
            this.error('Weather entity not found in HA');

          //set weather temperature
          if (this.hass.states['sensor.weather_temperature'])
            this.temp = Math.ceil((this.hass.states['sensor.weather_temperature']).state);

          //if the above sensor is not found look for the dark sky one
          else if (this.hass.states['sensor.dark_sky_temperature'])
            this.temp = Math.ceil((this.hass.states['sensor.dark_sky_temperature']).state);

          //if either isn't found show an error
          else this.error('Weather temperature entity not found in HA');
        }

        // Updates time on the panel if enabled
        updateTime(hass){
          if (this.alarm && this.alarm.attributes.panel){
            if (this.isChecked(this.alarm.attributes.panel.enable_clock)){
              if (this.hass.states['sensor.time'] == null){
                this.error('Time Sensor (sensor.time) not found in HA');
                return;
              }

              this.time = this.hass.states['sensor.time'].state;

              if (this.isChecked(this.alarm.attributes.panel.enable_clock_12hr))
                if ((parseInt(String(this.time).split(':')[0]) - 12) > 0 )
                  this.time = String( parseInt( String(this.time).split(':')[0] ) - 12 ) + ":" + String(this.time).split(':')[1];
            }
          }
        }

        // Is the alarm disarmed?
        isDisarmed(alarm){
          return alarm.state == 'disarmed';
        }

        // Is the alarm in Pending state?
        isPending(alarm){
          return alarm.state == 'pending';
        }

        // Is the alarm in Warning state?
        isWarning(alarm){
          return alarm.state == 'warning';
        }
        // Return a list of open sensors built from sensors
        opensensors(alarm, sensors)   {
          var ret = [];

          if (sensors != null)
            ret = sensors.filter(function (e){ return alarm.attributes.supported_statuses_on.indexOf(e.state.toLowerCase()) > -1; });

          this.opencount = ret.length;

          //if (ret.length > 0)
          //  console.log("%i opensensors:", ret.length);
          //ret.forEach(function (obj) {console.log("\t" + obj.entity_id + ":" + obj.state);});

          return ret;
        }

        opensensors_for_attempted_arm(alarm) {
          if (this.attemptedArm == true) {
            var arm_state = this.service_name2arm_state(this.attemptArmMode);
            return this.opensensors(alarm, this.computeSensors(this.hass, alarm.attributes.states[arm_state][this.INT_ATTR_STATE_CHECK_BEFORE_ARM]) );
          }
          else
            return []
        }

        // Get closed sensors
        closedsensors(alarm, sensors)   {
          var ret = [];
          if (sensors == false){
            return false;
          } else {
            ret = sensors.filter(function (e){ return alarm.attributes.supported_statuses_off.indexOf(e.state.toLowerCase()) > -1; });
            return ret;
          }
        }

        // determine whether a sensor is in a particular group
        computeSensors(hass, ids){
          if (ids == undefined){
          // Control the exception when this.alarm is not ready
            return false;
          } else {
            return ids.map(function (key){ return hass.states[key]; }).filter(function (e){ return e != undefined; });
          }
        }

        // Determine if array is empty
        computeArray(array){
          if (array.length > 0){
            return true;
          }
          return false;
        }

        //Provide a readable label
        computeLabel(state){
          switch (state){
            case 'disarmed':      return 'Disarmed';
            case 'armed_away':    return 'Armed - Away';
            case 'armed_home':    return 'Armed - Home';
            case 'armed_night':   return 'Armed - Night';
            case 'pending':       return '_Leave..';
            case 'warning':       return '_Warning';
            case 'triggered':     return '_Triggered';
          }
          return state;
        }

        //Get the friendly readable name of an entity
        computeFriendlyName(entity) {
          //console.log("computeFriendlyName(%s)", entity)
          if (this.hass.states[entity] == null) {
            console.log("Unknown entity \"%s\"", entity);
            return 'unknown';
          }
          var attr = this.hass.states[entity].attributes;
          //console.log("Friendly name: %s", attr.friendly_name);
          return attr.friendly_name;
          }

        // Change color of button
        computeButtonColor(count){
          if (count > 0) {
            return 'var(--dark-orange)';
          }
          return 'var(--info-panel-buttons)';
        }

        // Gets an image from the username
        computeImage(image){
          var FNAME = '[computeImage] '
          if (image == null || image == ''){
            //console.log(FNAME, "empty/null image name, return ", this.default_icon_path);
            return this.default_icon_path
          }
          else{
             image = this.image_path + image;
            if (this.urlExists(image)){
              //console.log(FNAME, "image exists, return ", image);
              return image;
            }
            else{
              //console.log(FNAME, "image ", image, " does not exist, return ", this.default_icon_path);
              return this.default_icon_path;
            }
          }
        }

        urlExists(url){
          //console.log("urlExists(%s)", url)
          try {
            var http = new XMLHttpRequest();
            http.open('HEAD', url, false);
            http.send();
            //console.log("urlExists(%s) status = ", url, http.status)
            return http.status != 404;
          }
          catch(err){
            console.log("urlExists(%s) catched error: %s, return false", url, err)
            return false;
          }
        }

        //Reverses an array
        reverseArray(array, quantity){
          if (array) {
            if (quantity == 'all') quantity = array.length - 1;
            return array.reverse().slice(0, quantity);
          }
        }

        //Mask the input code if enabled otherwise build up the code from inputs
        callcode(ev){
          ev.stopPropagation();
          var digit = ev.target.getAttribute('data-digit');
          this.code = this.code + digit;
          var display_digit = digit;
          if (this.isChecked(this.alarm.attributes.panel.hide_passcode))
            display_digit = '*';
          this.display_code = this.display_code + display_digit;
          this.alarm_state = this.display_code;
        }

        //Reset the display alarm codes
        callclearcode(ev){
          if (ev) ev.stopPropagation();
          this.code = '';
          this.display_code = '';
          this.alarm_state = this.computeLabel(this.alarm.state);
        }

        //If you require a code to arm the system then force it here
        showCodePanel(alarm){
          if (alarm === null || alarm === undefined)
            return false;
          return this.isChecked(alarm.attributes.code_arm_required) || !this.isDisarmed(alarm);
        }
        // need it to avoid nesting 3 templates
        showCodePanelWhenBothFalse(alarm, arg_1, arg_2) {
          return this.showCodePanel(alarm) && ! arg_1 && !arg_2;
        }

        //An Alarm service has been requested, execute it
        callAlarmService(ev){
          ev.stopPropagation();

          this.showArmPanel   = false;
          var call            = ev.target.getAttribute('data-call');

          switch (call){
            //Check for open sensors before arming the alarm.
            case 'arm':
              // do we have a code here?
              if (this.alarm.attributes.code_arm_required == true && !this.code) {
                console.log("empty codes are not supported!");
                this.attemptedArmWithoutCode = true;
                this.$.content.classList.add('shake');
                break;
              }
              this.attemptArmMode = ev.target.getAttribute('data-arm');
              try {
                if ( this.hasOpenSensors(this.attemptArmMode) ) {
                  //display the warning message and shake
                  this.attemptedArm = true;
                  this.$.content.classList.add('shake');
                  return;
                }
              }
              catch(err) {
                console.log("Error: " + err);
                return;
              }
              this.alarmService(this.attemptArmMode);
              break;

            //The arming of the alarm has been cancelled, reset parameters.
            case 'cancel':
              this.attemptArmMode = '';
              this.resetUI();
              break;

            //Open sensors detected but overridden.
            case 'override':
              this.alarmService(this.attemptArmMode);
              this.resetUI();
              break;

            //Disarm the alarm.
            case 'disarm':
              // do we have a code here?
              if (this.code) {
                this.alarmService('alarm_disarm');
              }
              else {
                console.log("empty codes are not supported!");
                this.$.content.classList.add('shake');
              }
              break;
          }

          //Reset the display alarm codes
          this.callclearcode(null);
        }

        //Call one of the alarm services
        alarmService(call){
          var data = {"entity_id": this.alarm.entity_id, "code": this.code}
          // TODO!!
          this.hass.callService('alarm_control_panel', call, data);
        }

        //Restart Home Assistant
        restartHA(ev){
          ev.stopPropagation();
          this.hass.callService('homeassistant', 'restart');
        }

        //enable/disable user
        toggleUser(ev){
          var user_id = ev.target.getAttribute('data-userid');
          this.settingsUpdateUser(user_id, ev.target.checked);
        }

        //Show the user edit box and load the selected user
        editUser(ev){
          this.hideDiv('#user-add');
          this.unhideDiv('#userDetail');

          var user_id = ev.target.getAttribute('data-userid');

          for (var user in this.alarm.attributes.users) {
            if (this.alarm.attributes.users[user].id == user_id){
              //populate user name
              this.shadowRoot.querySelector('#user-name').value = this.alarm.attributes.users[user].name;
              //populate enabled toggle
              this.shadowRoot.querySelector('#user-enabled').checked = this.isChecked(this.alarm.attributes.users[user].enabled);
              //clear pascode
              this.shadowRoot.querySelector('#user-passcode').value = '';
              //populate user picture
              var picture = this.alarm.attributes.users[user].picture;
              this.loadPreviewImageFromName(picture);
              this.shadowRoot.querySelector('#user-picture').value = picture;
              this.shadowRoot.querySelector('#user-save').setAttribute('data-userID', user_id);
            }
          }
        }

        //Show the user edit box and load the selected user
        saveUser(ev){
          if (this.shadowRoot.querySelector('#user-passcode').value == ''){
            this.shadowRoot.querySelector('#user-passcode').classList.add('validation-error');
          }
          else {
            var user = {};
            user['id'] = ev.target.getAttribute('data-userid');
            user['name'] = this.shadowRoot.querySelector('#user-name').value.toLowerCase();
            user['enabled'] = this.shadowRoot.querySelector('#user-enabled').checked;
            user['code'] = this.shadowRoot.querySelector('#user-passcode').value;
            user['picture'] = this.shadowRoot.querySelector('#user-picture').value;
            if (ev.target.getAttribute('data-userid') != null)
              //Update Config
              this.settingsUpdateUser(user, 'update');
            else
              this.settingsUpdateUser(user, 'add');

            this.resetUserDetail();
          }
        }

        //Show the user edit box and load the selected user
        deleteUser(ev){
          var user = ev.target.getAttribute('data-userID');

          //Update Config
          this.settingsUpdateUser(user, 'delete');
          this.resetUserDetail();
        }

        //Reset user detail
        resetUserDetail(){
          this.hideDiv('#userDetail');
          this.unhideDiv('#user-add');
          this.shadowRoot.querySelector('#user-passcode').classList.remove('validation-error')
          this.shadowRoot.querySelector('#user-name').classList.remove('validation-error')

          //populate user name
          this.shadowRoot.querySelector('#user-name').value = '';
          //populate enabled toggle
          this.shadowRoot.querySelector('#user-enabled').checked = false;
          //clear pascode
          this.shadowRoot.querySelector('#user-passcode').value = '';
          //populate user picture
          this.shadowRoot.querySelector('#user-picture').value = '';
          //populate enabled toggle
        }

        async _loadData() {
          try {
            this._users = await this.hass.callWS({
              type: 'config/auth/list',
            });

            var userIDs = [];
            for (var alarmUser in this.alarm.attributes.users)
              userIDs.push(this.alarm.attributes.users[alarmUser].id);

            for (var haUser in this._users){
              if (!userIDs.includes(this._users[haUser].id)){
                console.log("No match: %s", this._users[haUser].id);
              //user name
              var user                               = {};

              user['id']                             = this._users[haUser].id;
              user['name']                           = this._users[haUser].name;
              user['enabled']                        = false;
              user['code']                           = this._users[haUser].id;
              user['picture']                        = this.default_icon_name;
              this.settingsUpdateUser(user, 'add');
            }
          }
         }
         catch (ex) {
           console.error("Cannot get users' list: ", ex.message);
         }
        }

        loadPreviewImageFromName(fname){
          //var FNAME='[loadPreviewImageFromName] ';
          //console.log(FNAME, "image = ", fname);
          var image = this.computeImage(fname);
          //console.log(FNAME, "will use image ", image);
          this.shadowRoot.querySelector('#user-badge').setAttribute('style', 'background-image: url("' + image + '");margin-top: auto; margin-bottom: auto; margin-right: 15px;');
        }

        loadPreviewImage(ev){
          this.loadPreviewImageFromName(ev.target.value);
        }

        //Read the settings that are to be updated
        settingsSave(ev){
          var FNAME = '[settingsSave] '
          ev.stopPropagation();

          //Check the settings tab has been unlocked before commiting any changes
          if (this.settingsUnlock == false){
            //console.log("settingsSave disabled, no data saved");
            return;
          }

            //Retrieve fields set in the html form
            var type = ev.target.getAttribute('data-type');
            var setting = ev.target.getAttribute('data-setting');
            var attribute = ev.target.getAttribute('data-attribute');

            var id = ev.target.getAttribute('id');
            var name = ev.target.getAttribute('name');
            var title = ev.target.getAttribute('title');
            var mode = ev.target.getAttribute('data-mode');
            var sensor_group = ev.target.getAttribute('data-group');

            var checked = ev.target.checked;

            var value = null;

            switch (setting) {
              case 'panel':
                if (typeof ev.target.checked === 'boolean')
                  this.alarm.attributes.panel[attribute] = ev.target.checked;
                else if (type == 'input_text')
                  this.alarm.attributes.panel[attribute] = this.shadowRoot.querySelector('#' + attribute).value;
                else if (type == 'listbox')
                  this.alarm.attributes.panel[attribute] = this.shadowRoot.querySelector('#' + attribute + '-listbox').selected;
                this.settingsUpdate(setting, this.alarm.attributes.panel);
                return;

              case 'themes':
                var pos = -1;

                // If themes dont exist create them
                if (this.alarm.attributes.themes == null){
                  this.alarm.attributes.themes = [];
                  this.settingsUpdate(setting, this.alarm.attributes.themes);
                  pos = 0
                }

                // try and find the selected theme
                for (var x in this.alarm.attributes.themes)
                  if (this.alarm.attributes.themes[x].name == name)
                    pos = x;

                // if theme isnt selected create one
                if (name == null){
                  this.alarm.attributes.themes.push({'name': this.shadowRoot.querySelector('#' + attribute).value});
                  this.settingsUpdate(setting, this.alarm.attributes.themes);
                  // this.unhideDiv('#themeDetail');
                  return;
                }
                else if (pos > -1 ){
                  if (type == 'color'){
                    this.alarm.attributes.themes[pos][attribute] = '#' + this.shadowRoot.querySelector('#' + attribute).value;
                    this.settingsUpdate(setting, this.alarm.attributes.themes);
                    return;
                  }
                  else if (type == 'input_text'){
                    this.alarm.attributes.themes[pos].name = this.shadowRoot.querySelector('#' + attribute).value;
                    this.settingsUpdate(setting, this.alarm.attributes.themes);
                    return;
                  }
                  else if (type == 'clear'){
                    this.shadowRoot.querySelector('#' + attribute).value = 'FFFFFF';
                    this.shadowRoot.querySelector('#' + attribute).setAttribute('style', 'background-color: rgb(255, 255, 255)');                  delete this.alarm.attributes.themes[pos][attribute];
                    this.settingsUpdate(setting, this.alarm.attributes.themes);
                    return;
                  }
                  else if (type == 'boolean'){
                    //Disable all others
                    for (var x in this.alarm.attributes.themes)
                      this.alarm.attributes.themes[x].active = false;
                    this.alarm.attributes.themes[pos].active = ev.target.checked;
                    this.settingsUpdate(setting, this.alarm.attributes.themes);
                    return;
                  }
                  else if (type == 'delete'){
                    this.alarm.attributes.themes.splice(pos,1);
                    this.settingsUpdate(setting, this.alarm.attributes.themes);
                    return;
                  }
                }
                return;

              case 'mqtt':
                if (this.alarm.attributes['mqtt'] === 'undefined')
                  this.alarm.attributes.mqtt = {}

                if (typeof ev.target.checked === 'boolean')
                  this.alarm.attributes.mqtt[attribute] = ev.target.checked;
                else if (type == 'input_text')
                  this.alarm.attributes.mqtt[attribute] = this.shadowRoot.querySelector('#' + attribute).value;
                this.settingsUpdate(setting, this.alarm.attributes.mqtt);
                return;

              case 'states':
                if (type == 'input_text')
                    this.alarm.attributes.states[mode][attribute] = this.shadowRoot.querySelector('#' + mode + '-' + attribute).value;

                this.settingsUpdate(setting, this.alarm.attributes.states);
                return;

              case 'root':
                if (typeof ev.target.checked === 'boolean')
                  value = ev.target.checked;
                else {
                  value = this.shadowRoot.querySelector('#' + attribute).value;
                  if (value == ''){
                    //set css class to red
                    return;
                  }
                }

                this.settingsUpdate(attribute, value);
                return;

              case 'sensor_select':
                //check if the sensor already exists in the groups
                var index = this.alarm.attributes.states[mode][sensor_group].indexOf(title);

                //add sensor to group
                if (typeof this.alarm.attributes.states[mode][sensor_group][index] === 'undefined')
                  this.alarm.attributes.states[mode][sensor_group].push(title);
                //remove sensor from group
                else if (index >= 0)
                  this.alarm.attributes.states[mode][sensor_group].splice(index, 1);

                this.settingsUpdate('states', this.alarm.attributes.states);
                return;

              default:
                return;
            }

            this.updateTheme();
        }

        //Call the service to update the yaml file
        settingsUpdate(setting, value){
          this.hass.callService('alarm_control_panel', 'alarm_yaml_save', {'configuration': setting, 'value': value });
        }

        //Call the service to update the yaml file
        settingsUpdateUser(user, command){
          this.hass.callService('alarm_control_panel', 'alarm_yaml_user', {'user': user, 'command': command });
        }

        service_name2arm_state(service_name) {
          switch(service_name) {
            case 'alarm_arm_home_from_panel':  return 'armed_home';
            case 'alarm_arm_away_from_panel':  return 'armed_away';
            case 'alarm_arm_night_from_panel': return 'armed_night';
            default:
              var msg = "service_name2arm_state: invalid service name \"" + service_name + "\"";
              console.log(msg);
              throw msg;
          }
        }

        hasOpenSensors(service_name) {
          var FNAME = 'hasOpenSensors'
          //check to see how many open sensors there are, if none arm alarm
          if (this.opencount == 0) {
            //console.log(FNAME + "(" + service_name + "): opencount == 0, return False");
            return false;
          }

          var arm_state = this.service_name2arm_state(service_name);
          var sensors = this.computeSensors(this.hass, this.alarm.attributes.states[arm_state][this.INT_ATTR_STATE_CHECK_BEFORE_ARM]);
          for (var index in sensors) {
            var sensor = sensors[index];
            if (this.alarm.attributes.supported_statuses_on.indexOf(sensor.state.toLowerCase()) > -1) {
              // console.log(FNAME + "(" + service_name + "): " + sensor + " is " + sensor.state + ", return True");
              return true;
            }
          }

          // console.log(FNAME + "(" + service_name + "): return False");
          return false;
        }

        //Cancel the attempted alarm and reset UI
        resetUI(){
          this.attemptedArm = false;
          this.attemptedArmWithoutCode = false;

          //Remove the page shake from open sensors
          this.$.content.classList.remove('shake');
        }

        // Observer: polymer gaurantees that this won't be called util hass and panel are both defined
        onPanelUpdate(hass, panel){
          this.alarm = hass.states[panel.config.alarmid];
          // config.log("onPanelUpdate: ", panel.config.alarmid);
        }

        fire(type, detail, options) {
          options = options || {};
          detail = (detail === null || detail === undefined) ? {} : detail;
          const event = new Event(type, {
            bubbles: options.bubbles === undefined ? true : options.bubbles,
            cancelable: Boolean(options.cancelable),
            composed: options.composed === undefined ? true : options.composed
          });
          event.detail = detail;
          const node = options.node || this;
          node.dispatchEvent(event);
          return event;
        }

        mwc_button_wrapper_class() {
          return this.__mwc_button_wrapper_class;
        }

        mwc_button__outlined() {
          return this.__mwc_button__base_style + this.__mwc_button__outlined;
        }

        mwc_button__raised() {
          return this.__mwc_button__base_style + this.__mwc_button__raised;
        }

        invisibleIfDisarmed(alarm) {
          return this.isDisarmed(alarm)? 'invisible' : '';
        }

        bothFalse(arg_1, arg_2) {
          return !arg_1 && !arg_2;
        }

        needHorizontalCodepanel(orientationLandscape, code_arm_required) {
          var result = orientationLandscape || this.isChecked(code_arm_required);
          console.log('needHorizontalCodepanel: orientationLandscape=' + orientationLandscape + ', code_arm_required=' + this.isChecked(code_arm_required) + ', result=' + result);
          return result;
        }
      }

      customElements.define(HaPanelAlarm.is, HaPanelAlarm);
    }
  </script>
